<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ExploRide ‚Äì Wielka Mapa Urbexu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; background-color: #1e1e1e; color: #f0f0f0;}
    #map, #sidebar, #basemap-switcher, #layer-editor, #route-editor { display: none; }
    #map { position: absolute; top: 0; left: 300px; right: 225px; bottom: 0; }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
   border-color: #444;
    background: #2b2b2b;
    color: #f0f0f0;
      border-right: 1px solid #ccc;
      padding: 10px;
    }
    #sidebar-inner {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #lista-warstw {
      overflow-y: auto;
      flex: 1;
      border-top: 1px solid #444;
        padding-top: 8px; /* lub ile tam chcesz odstƒôpu */
    }
    #basemap-switcher {
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 100%;
      background-color: #2b2b2b;
      border-color: #444;
      color: #f0f0f0;
      border-left: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
    }
    #layer-editor {
      position: absolute;
      top: 0;
      left: 300px;
      width: 200px;
      height: 100%;
      background-color: #2b2b2b;
      border-color: #444;
      color: #f0f0f0;
      border-left: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      z-index: 1550;
      pointer-events: auto;
    }
    #route-editor {
      position: absolute;
      top: 0;
      left: 300px;
      width: 200px;
      height: 100%;
      background-color: #2b2b2b;
      border-color: #444;
      color: #f0f0f0;
      border-left: 1px solid #ccc;
      padding: 10px;
      overflow-y: auto;
      z-index: 1550;
      pointer-events: auto;
      display: none;
    }
    .trasy-lista { margin-left: 15px; }
    .trasa-item { font-size: 12px; cursor: pointer; padding-left: 4px; }
    .route-line { stroke-width: 4; }
    .route-line:hover { filter: drop-shadow(0 0 3px black); }
    .layer-separator {
      border-bottom: 1px solid #555;
      margin: 5px 0;
    }
    #wyszukiwarka { width: 80%; margin-bottom: 10px; padding: 5px; flex-shrink: 0; }
    .pinezka { 
      margin: 7px 0; cursor: pointer; color: #f0f0f0; font-size: 12px; 
      padding-bottom: 6px;
      border-bottom: 1px solid #444;
      margin-bottom: 6px;
             }
    #narzedzia {
      margin-bottom: 10px;
    flex-shrink: 0;
    position: fixed !important;
    top: 50px;
    left: 315px;
    z-index: 1000; 
    }
    .tool-btn {
      font-size: 24px;
      background: #2b2b2b;
      border: 1px solid #444;
      border-radius: 4px;
      cursor: pointer;
      font-family: "Noto Color Emoji", sans-serif;
    }
    .tool-btn img { border: none; border-radius: 4px; }
    .tool-btn.active { background: #444; }
    .pinezka.active { color: #007bff; font-weight: bold; }
    .pinezka:hover { text-decoration: underline; }
    .warstwa { margin-bottom: 10px; }
    .dragging { opacity: 0.5; }
    .warstwa h3 { margin: 5px 0; font-size: 16px; display: flex; align-items: center; cursor: pointer; }
    .warstwa input[type="checkbox"] { margin-right: 5px; }
    .layer-number { margin-right: 5px; color: #bbb; cursor: move; user-select: none; font-size: 12px}
    .layer-number.dragging { opacity: 0.5; }
    .pinezki-lista { margin-left: 10px; display: block; }
    .ukryta { display: none; }
    #ekran-logowania {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #loginBtn {
      font-size: 18px;
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .hillshade-dark { filter: grayscale(100%) brightness(60%); }
    .emoji-marker { background: none; border: none; }
        .emoji-sztosy {
  font-family: 'Noto Color Emoji', sans-serif;
  font-size: 28px;
  line-height: 32px;
  position: relative;
  color: inherit;
  text-shadow:
    /*
        -2px -2px 0 #000,
     2px -2px 0 #000,
    -2px  2px 0 #000,
     2px  2px 0 #000,
    */

    /* gruby z≈Çoty kontur - na wierzchu */
    -1px -1px 0 gold,
     1px -1px 0 orange,
    -1px  1px 0 gold,
     1px  1px 0 orange;

          
}
  .emoji-marker span {
  font-family: 'Noto Color Emoji', sans-serif;
 /* font-size: 28px; */
  line-height: 32px;
}

    .emoji-marker span:not(.emoji-sztosy) {
  text-shadow:
    /*
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
  */
     filter: drop-shadow(0 0 1px black)
          drop-shadow(0 0 1px black)
          drop-shadow(0 0 1px black)
          drop-shadow(0 0 1px black);
}
    .emoji-inline {
width: 15px;
    height: 15px;
    vertical-align: TOP;
    }
    .hidden-text { display: none; }

    #geosearch {
      position: absolute;
      top: 10px;
      left: 310px;
      right: 600px;
      padding: 5px;
      z-index: 1000;
    }
    .unsaved {
      color: red;
    }
    .inactive {
      opacity: 0.5;
      color: #999;
      filter: saturate(50%);
    }
    #exportKML {
      background-color: #007bff;
      position: fixed;
      bottom: 70px;
      right: 45px;
      z-index: 1000;
    }
    #map.pin-cursor {
      cursor: url('https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2.png') 13 43, auto !important;
    }
      .leaflet-grab {
    cursor: default !important;
  }
     .leaflet-dragging .leaflet-grab {
    cursor: grabbing !important;
  }
    ::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #2a2a2a;
}

::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 5px;
  border: 2px solid #2a2a2a;
}

::-webkit-scrollbar-thumb:hover {
  background-color: #777;
}

/* Scrollbar dla Firefox */
body, #sidebar, #basemap-switcher {
  scrollbar-width: thin;
  scrollbar-color: #555 #2a2a2a;
}
    #lista-warstw {
  scrollbar-width: thin;
  scrollbar-color: #555 #1e1e1e;
}

/* Dla Chrome, Edge, Safari */
#lista-warstw::-webkit-scrollbar {
  width: 8px;
}

#lista-warstw::-webkit-scrollbar-track {
  background: #1e1e1e;
}

#lista-warstw::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

#lista-warstw::-webkit-scrollbar-thumb:hover {
  background-color: #777;
}
    #logoNaglowek {
  text-align: center;
  font-weight: bold;
  font-size: 20px;
  margin: 0 0 10px 0;
  color: #f0f0f0;
}
.emoji-obrys {
  filter: drop-shadow(0 0 0.1px black)
          drop-shadow(1px 1px 1px black)
          drop-shadow(-1px -1px 1px black);
  vertical-align: middle;
  margin-right: 5px;
  border-radius: 2px;
}

.emoji-obrys-sztosy {
  filter: drop-shadow(0 0 0.1px gold)
          drop-shadow(1px 1px 1px orange)
          drop-shadow(-1px -1px 1px gold);
  drop-shadow(0 0 2px black)
          drop-shadow(2px 2px 2px black)
          drop-shadow(-2px -2px 2px black);
  vertical-align: middle;
  margin-right: 5px;
  border-radius: 2px;
}
.popup-container {
  position: relative;
  padding-bottom: 24px;
}
.edit-popup {
  min-width: 300px;
}
.popup-edit-btn {
  position: absolute;
  bottom: 0;
  right: 0;
}
.popup-photo {
  width: 100%;
  max-height: 150px;
  object-fit: cover;
  cursor: pointer;
}
.photo-gallery {
  display: flex;
  overflow-x: auto;
  gap: 2px;
  margin-bottom: 4px;
}
.photo-item {
  position: relative;
  flex: 0 0 auto;
}
.photo-delete {
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  font-size: 14px;
  padding: 2px;
  cursor: pointer;
  display: none;
}
.edit-popup .photo-item:hover .photo-delete {
  display: block;
}
#photoModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}
#photoModal img {
  max-width: 90%;
  max-height: 90%;
}
#photoModalClose {
  position: absolute;
  top: 20px;
  right: 30px;
  color: #fff;
  font-size: 32px;
  cursor: pointer;
  z-index: 2101;
}
#photoModalDelete {
  position: absolute;
  top: 20px;
  right: 80px;
  color: #fff;
  font-size: 32px;
  cursor: pointer;
  z-index: 2101;
  display: none;
}

#deleteModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 2000;
  color: #fff;
}

#deleteModalContent {
  background: #2b2b2b;
  border: 1px solid #444;
  padding: 20px;
  text-align: center;
}

#deleteModal button {
  margin: 5px;
}
#layerDeleteModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  justify-content: center;
  align-items: center;
  z-index: 2000;
  color: #fff;
}
#layerDeleteModalContent {
  background: #2b2b2b;
  border: 1px solid #444;
  padding: 20px;
  text-align: center;
}
#layerDeleteModal button {
  margin: 5px;
}

.leaflet-popup-content {
  max-width: 300px;
}

.leaflet-popup-content-wrapper {
  background: #2b2b2b;
  color: #f0f0f0;
  border: 1px solid #444;
}

.leaflet-popup-tip {
  background: #2b2b2b;
  border: 1px solid #444;
}

.leaflet-popup-close-button {
  color: #f0f0f0;
}

.popup-description.scrollable {
  max-height: 150px;
  overflow-y: auto;
}
.sztosy-gwiazda {
  position: absolute;
  top: -8px;
  right: -6px;
  font-size: 18px;
  padding: 1px;
  line-height: 1;
  z-index: 10;
       filter: drop-shadow(0 0 0.2px red)
          drop-shadow(0 0 1px red)
          drop-shadow(0 0 1px red)
          drop-shadow(0 0 1px red);
}
.zwiedzone-check {
  position: absolute;
  top: -8px;
  right: -6px;
  z-index: 10;
}
.checkmark-obrys {
  filter: drop-shadow(0 0 0.5px black) drop-shadow(1px 1px 0 black) drop-shadow(-1px -1px 0 black);
  border-radius: 2px;
}

#loading {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2000;
  display: none;
}
.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #007bff;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

#toggleLayers { display: none; }

@media (max-width: 700px) {
  #map { left: 0 !important; right: 0 !important; }
  #sidebar { position: fixed; transform: translateX(-100%); transition: transform 0.3s ease; width: 260px; z-index: 1500; }
  #sidebar.show { transform: translateX(0); }
  #basemap-switcher { display: none; }
  #narzedzia { left: 10px; top: 140px; }
  #geosearch { left: 10px; right: 10px; top: 90px; }
  #gpsFollowBtn {
    position: fixed;
    bottom: 20px;
    right: 15px;
    z-index: 1000;
    background: #2b2b2b;
    color: #f0f0f0;
    border: 1px solid #444;
    padding: 8px 12px;
    border-radius: 4px;
    display: none;
  }
  #exportKML { display: none; }
  .leaflet-control-zoom { left: 10px; }
  #toggleLayers { position: fixed; top: 10px; left: 10px; z-index: 1600; background: #2b2b2b; color: #f0f0f0; border: 1px solid #444; padding: 5px 10px; display: block; }
}

  </style>
</head>
<body>
  <div id="ekran-logowania"><button id="loginBtn">Zaloguj siƒô przez Google</button></div>
  <div id="loading"><div class="loader"></div></div>
  <div id="sidebar">
    <div id="sidebar-inner">
      <h2 id="logoNaglowek">ExploMapy</h2>
      <input type="text" id="wyszukiwarka" placeholder="Szukaj pinezki...">
      <select id="sortowanie">
        <option value="dateDesc">Sortuj wg daty ‚Äì od najnowszych</option>
        <option value="dateAsc">Sortuj wg daty ‚Äì od najstarszych</option>
        <option value="nameAsc">Sortuj alfabetycznie A‚ÜíZ</option>
        <option value="nameDesc">Sortuj alfabetycznie Z‚ÜíA</option>
      </select>
      <details id="filterKategorie">
        <summary>Filtruj kategorie</summary>
        <div id="kategorie-lista"></div>
      </details>
      <button id="addLayerBtn">+ Nowa warstwa</button>
      <input type="text" id="newLayerInput" style="display:none;width:90%;margin-top:5px;" placeholder="Nazwa warstwy">
        <button id="collapseAllLayers">Rozwi≈Ñ wszystkie warstwy</button>
      <button id="toggleVisibility">Ukryj wszystkie warstwy</button>
      <button id="loadPinsBtn">Za≈Çaduj pinezki</button>
      <div id="lista-warstw"></div>
    </div>
  </div>
  <input type="text" id="geosearch" placeholder="Szukaj adresu lub wsp√≥≈Çrzƒôdnych...">
  <div id="narzedzia">
    <button id="handTool" class="tool-btn">
      <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f44b.svg" width="24" height="24" alt="hand">
    </button>
    <button id="pinTool" class="tool-btn">
      <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4cd.svg" width="24" height="24" alt="pin">
    </button>
  </div>
  <div id="map"></div>
  <button id="toggleLayers">‚ò∞ Warstwy</button>
  <div id="basemap-switcher">
    <h3>Rodzaj mapy</h3>
    <label><input type="radio" name="basemap" value="osm"> Mapa podstawowa</label><br>
    <label><input type="radio" name="basemap" value="sat" checked> Satelitarna + miasta + drogi</label><br>
    <label><input type="radio" name="basemap" value="hill"> Cieniowanie + miasta + drogi</label><br>
    <label><input type="radio" name="basemap" value="hist"> Mapa historyczna (Geoportal)</label>

    <h3>Widok ulic</h3>
    <label><input type="radio" name="streets" value="full" checked> Wszystkie ulice</label><br>
    <label><input type="radio" name="streets" value="main"> Tylko g≈Ç√≥wne trasy</label><br>

    <div id="route-controls">
      <h3>Wyznacz trasƒô</h3>
      <input type="text" id="routeStart" placeholder="Punkt poczƒÖtkowy"><br>
      <input type="text" id="routeEnd" placeholder="Punkt ko≈Ñcowy"><br>
      <button id="routeCalculate">Poka≈º trasƒô</button>
    </div>
  </div>
  <div id="layer-editor">
    <h3>Edycja warstwy</h3>
    <input type="text" id="layerEditName" placeholder="Nazwa warstwy"><br>
    <input type="number" id="layerEditOrder" min="1" style="width:70px;"> <button id="layerEditSave" onclick="applyLayerEdits()">Zastosuj</button><br>
    <input id="layerEditEmoji" placeholder="Emoji warstwy" style="width:100%"><br>
    <button id="layerEditDelete">Usu≈Ñ warstwƒô</button>
    <button id="layerEditClose" onclick="closeLayerEditor()">Zamknij</button>
  </div>
  <div id="route-editor">
    <h3>Edycja trasy</h3>
    <input type="text" id="routeEditName" placeholder="Nazwa trasy"><br>
    <textarea id="routeEditDesc" placeholder="Opis trasy" style="width:100%"></textarea><br>
    <input type="color" id="routeEditColor"><br>
    <button id="routeEditDelete">Usu≈Ñ trasƒô</button>
    <button id="routeEditClose" onclick="closeRouteEditor()">Zamknij</button>
    <button id="routeEditApply" onclick="applyRouteEdits()">Zastosuj</button>
  </div>
  <button id="exportKML">Zapisz do .KML</button>
  <button id="saveChanges">Zapisz edycjƒô mapy</button>
  <button id="gpsFollowBtn">GPS</button>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="emoji-list.js"></script>

  <script>
    const emojiMap = {};
    emojiList.forEach(e => { emojiMap[e.id] = e.url; });

    function resolveEmoji(val) {
      if (!val) return val;
      return emojiMap[val] || val;
    }

function slugify(str) {
  return str
    .normalize("NFKD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9_-]/gi, "_")
    .toLowerCase();
}

    function sanitize(str) {
      return String(str || '').replace(/[\/%?#]/g, '_');
    }

    function generateSuffix(len = 6) {
      const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
      let out = '';
      for (let i = 0; i < len; i++) {
        out += chars[Math.floor(Math.random() * chars.length)];
      }
      return out;
    }

    // === [CODEx ADDED] Kompresja obraz√≥w ===
    const IMG_COMPRESS = {
      maxEdge: 1600,   // d≈Çu≈ºszy bok skalujemy do 1600 px
      quality: 0.82,   // jako≈õƒá JPEG
      targetKB: 350,   // docelowy rozmiar ~350 KB (0 = wy≈ÇƒÖcz)
      minQuality: 0.6, // nie schod≈∫ ni≈ºej
      step: 0.06,      // krok obni≈ºania jako≈õci
    };

    async function compressDataUrl(dataUrl, opts = {}) {
      const cfg = { ...IMG_COMPRESS, ...opts };

      // Je≈õli ma≈Çy JPEG i brak targetu ‚Äî zwr√≥ƒá jak jest
      if (!cfg.targetKB && dataUrl.startsWith('data:image/jpeg') && dataUrl.length < 250_000) {
        return dataUrl;
      }

      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = dataUrl;
      });

      let { width, height } = img;
      const longer = Math.max(width, height);

      // Skalowanie do maxEdge
      let canvas = document.createElement('canvas');
      let ctx = canvas.getContext('2d', { alpha: false });

      if (longer > cfg.maxEdge) {
        const scale = cfg.maxEdge / longer;
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }

      canvas.width = width;
      canvas.height = height;

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, width, height);

      let q = cfg.quality;
      let out = canvas.toDataURL('image/jpeg', q);

      if (cfg.targetKB > 0) {
        const targetBytes = cfg.targetKB * 1024;
        let iter = 0;
        while (out.length > targetBytes && q > cfg.minQuality && iter < 6) {
          q = Math.max(cfg.minQuality, q - cfg.step);
          out = canvas.toDataURL('image/jpeg', q);
          iter++;
        }
      }

      canvas.width = 0; canvas.height = 0; canvas = null; ctx = null;
      return out;
    }

    document.getElementById("loginBtn").addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider);
    });

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return;
      if (user.email !== "eksplorajder@gmail.com") {
        alert("Brak dostƒôpu.");
        return;
      }
      document.getElementById("ekran-logowania").style.display = "none";
      document.getElementById("map").style.display = "block";
      document.getElementById("sidebar").style.display = "block";
      document.getElementById("basemap-switcher").style.display = "block";
      initMap();
      loadLayersFromFirestore().then(() => {
        if (window.innerWidth <= 700) {
          loadNewPinsFromLocal();
          generujListeWarstw();
        } else {
          zaladujPinezkiZFirestore();
        }
        initGeoSearch();
        setupMobile();
        initRouteSearch();
        if (window.innerWidth <= 700) {
          const loadBtn = document.getElementById('loadPinsBtn');
          if (loadBtn) {
            loadBtn.addEventListener('click', () => {
              zaladujPinezkiZFirestore();
              loadBtn.style.display = 'none';
            }, { once: true });
          }
        }
      });
    });

    let map, baseLayer, routingLayer, roadsLayer;
    let currentBase = 'sat';
    let loadingCount = 0;
    function showLoading() {
      const el = document.getElementById('loading');
      if (loadingCount === 0 && el) el.style.display = 'block';
      loadingCount++;
    }
    function hideLoading() {
      if (loadingCount > 0) loadingCount--;
      if (loadingCount === 0) {
        const el = document.getElementById('loading');
        if (el) el.style.display = 'none';
      }
    }
    const warstwy = {};
    let wszystkiePinezki = [];
    let draggedLayer = null;
    let highlightedItem = null;
    let zmianyDoZapisania = {};
    let nowePinezki = [];
    let localPinsLoaded = false;
    const photosMap = {};
    let sortMode = 'dateDesc';
    const categories = new Set();
    let selectedCategories = new Set();
    const layerDocs = {};
    const layerNamesById = {};
    let sztosyId = null;
    let visitedId = null;
    let movingLayerId = null;
    const orangeLayerId = 'Pwgv6ssxu9sTvrjTaB43';
    let layerEmojiChanges = {};
    let layersToAdd = [];
    let layersToDelete = [];
    let pinsToDelete = [];
    let initialLayerOrder = [];
    let layerOrderChanged = false;
    let currentTool = "hand";
    let initialLayerVisibilitySet = false;
    const rysowaneTrasy = new L.FeatureGroup();
    window.localTrasy = [];
    let drawingRoute = false;
    let activeRoutePin = null;
    const handBtn = document.getElementById("handTool");
    const pinBtn = document.getElementById("pinTool");
    const mapEl = document.getElementById("map");
    let searchLayer = null;
    let searchMarker = null;
    const greenIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });
    const sortSelect = document.getElementById('sortowanie');
    sortSelect.addEventListener('change', () => {
      sortMode = sortSelect.value;
      generujListeWarstw();
    });

    const toggleLayersBtn = document.getElementById("toggleLayers");
    const sidebarEl = document.getElementById("sidebar");
    if (toggleLayersBtn && sidebarEl) {
      toggleLayersBtn.addEventListener("click", () => {
        sidebarEl.classList.toggle("show");
      });
    }
    const addLayerBtn = document.getElementById('addLayerBtn');
    const newLayerInput = document.getElementById('newLayerInput');
    const collapseAllBtn = document.getElementById('collapseAllLayers');
    const toggleVisibilityBtn = document.getElementById('toggleVisibility');
    let allLayersCollapsed = true;
    let allLayersVisible = true;
    if (addLayerBtn && newLayerInput) {
      addLayerBtn.addEventListener('click', () => {
        newLayerInput.style.display = 'block';
        newLayerInput.focus();
      });
      newLayerInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          addLayer(e.target.value.trim());
          e.target.value = '';
          e.target.style.display = 'none';
        } else if (e.key === 'Escape') {
          e.target.value = '';
          e.target.style.display = 'none';
        }
      });
    }
    if (collapseAllBtn) {
      collapseAllBtn.addEventListener('click', () => {
        allLayersCollapsed = !allLayersCollapsed;
        Object.keys(warstwy).forEach(n => {
          warstwy[n].collapsed = allLayersCollapsed;
        });
        collapseAllBtn.textContent = allLayersCollapsed ? 'Rozwi≈Ñ wszystkie warstwy' : 'Zwi≈Ñ wszystkie warstwy';
        generujListeWarstw();
      });
    }
    if (toggleVisibilityBtn) {
      toggleVisibilityBtn.addEventListener('click', () => {
        allLayersVisible = !allLayersVisible;
        Object.keys(warstwy).forEach(n => {
          warstwy[n].visible = allLayersVisible;
          if (allLayersVisible) {
            warstwy[n].layer.addTo(map);
          } else {
            map.removeLayer(warstwy[n].layer);
          }
        });
        toggleVisibilityBtn.textContent = allLayersVisible ? 'Ukryj wszystkie warstwy' : 'Poka≈º wszystkie warstwy';
        generujListeWarstw();
      });
    }

    function updateSaveButton() {
      const btn = document.getElementById('saveChanges');
      if (!btn) return;
      const layerChanges = layersToAdd.length > 0 || layersToDelete.length > 0 || layerOrderChanged || Object.keys(layerEmojiChanges).length > 0;
      const routeChanges = window.localTrasy.length > 0;
      btn.style.display = (Object.keys(zmianyDoZapisania).length > 0 || nowePinezki.length > 0 || layerChanges || routeChanges) ? 'block' : 'none';
    }

    function markPinUnsaved(slug) {
      const p = wszystkiePinezki.find(pp => pp.slug === slug);
      if (p) {
        p.unsaved = true;
        if (!zmianyDoZapisania[p.id]) zmianyDoZapisania[p.id] = {};
      }
      updateSaveButton();
    }
    function selectTool(t) {
      currentTool = t;
      handBtn.classList.toggle("active", t === "hand");
      pinBtn.classList.toggle("active", t === "pin");
      if (mapEl) {
        if (t === "pin") {
          mapEl.classList.add("pin-cursor");
        } else {
          mapEl.classList.remove("pin-cursor");
        }
      }
      const cm = document.getElementById('centerMarker');
      if (cm) {
        if (t === 'pin' && window.innerWidth <= 800) {
          cm.style.display = 'block';
        } else {
          cm.style.display = 'none';
        }
      }
    }
    if (handBtn) handBtn.addEventListener("click", () => selectTool("hand"));
if (pinBtn) pinBtn.addEventListener("click", () => selectTool("pin"));
    selectTool("hand");

    window.addEventListener('beforeunload', e => {
      if (Object.keys(zmianyDoZapisania).length > 0 || nowePinezki.length > 0) {
        e.preventDefault();
        e.returnValue = 'Masz niezapisane zmiany. Czy na pewno chcesz wyj≈õƒá?';
      }
    });

    function linkify(text) {
      if (!text) return '';
      const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/g;
      return text
        .replace(urlRegex, url => {
          const href = url.startsWith('http') ? url : `https://${url}`;
          let display;
          try {
            display = new URL(href).hostname.replace(/^www\./, '');
          } catch (e) {
            display = url;
          }
          return `<a href="${href}" target="_blank">${display}</a>`;
        })
        .replace(/\n/g, '<br>');
    }

    function formatCoords(lat, lng) {
      return `${Number(lat).toFixed(5)}, ${Number(lng).toFixed(5)}`;
    }

    function formatDate(ts) {
      if (!ts) return 'brak daty';
      try {
        const d = new Date(ts);
        if (isNaN(d)) return 'brak daty';
        return d.toLocaleDateString('pl-PL');
      } catch (e) {
        return 'brak daty';
      }
    }

    function trudnoscText(val) {
      switch (parseInt(val, 10)) {
        case 1: return 'Bardzo ≈Çatwy';
        case 2: return '≈Åatwy';
        case 3: return '≈öredni';
        case 4: return 'Trudny';
        case 5: return 'Bardzo trudny';
        default: return '';
      }
    }

    function trudnoscColor(val) {
      switch (parseInt(val, 10)) {
        case 1: return 'green';
        case 2: return 'limegreen';
        case 3: return 'yellow';
        case 4: return 'orange';
        case 5: return 'red';
        default: return '';
      }
    }

    function createEmojiIcon(emojiOrUrl, warstwaId, size = 32) {
      emojiOrUrl = resolveEmoji(emojiOrUrl);
      const isVisited = warstwaId && warstwaId === visitedId;
      const isSztosy = warstwaId && warstwaId === sztosyId;
      if (warstwaId && warstwaId === orangeLayerId) {
        return L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png',
          iconSize: [size, size],
          iconAnchor: [size / 2, size]
        });
      }
      if (warstwaId && warstwaId === movingLayerId) {
        return L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
          iconSize: [size, size],
          iconAnchor: [size / 2, size]
        });
      }

      if (!emojiOrUrl || String(emojiOrUrl).trim() === "" || emojiOrUrl === "undefined") {
        return L.icon({
          iconUrl: 'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png',
          iconSize: [size * 0.56, size * 0.9],
          iconAnchor: [size * 0.28, size * 0.9]
        });
      }

      const isUrl = emojiOrUrl && emojiOrUrl.startsWith("http");
      const overlay = isSztosy
        ? `<span class="sztosy-gwiazda">‚≠ê</span>`
        : isVisited
          ? `<img src="https://upload.wikimedia.org/wikipedia/commons/0/03/Green_check.svg" width="20" height="20" class="zwiedzone-check checkmark-obrys">`
          : '';

      if (isUrl) {
        const cls = isSztosy ? "emoji-obrys-sztosy" : "emoji-obrys";
        return L.divIcon({
          className: 'emoji-marker',
          html: `
            <div style="position: relative; display: inline-block;">
              <img src="${emojiOrUrl}" class="${cls}" width="28" height="28">
              ${overlay}
            </div>`,
          iconSize: [size, size],
          iconAnchor: [size / 2, size]
        });
      }

      const cls = isSztosy ? "emoji-sztosy" : "";

      return L.divIcon({
        className: 'emoji-marker',
        html: `
          <div style="position: relative; display: inline-block;">
            <span class="${cls}">${emojiOrUrl}</span>
            ${overlay}
          </div>`,
        iconSize: [size, size],
        iconAnchor: [size / 2, size]
      });
    }


function emojiHtml(str) {
  if (!str) return '';
  const url = resolveEmoji(str);
  if (url.startsWith('http')) {
    return `<span class="hidden-text">${str} </span><img src="${url}" class="emoji-inline">`;
  }
  return url;
}


    function getStoredPhotos(slug) {
      return (photosMap[slug] || []).slice();
    }

    function storePhotos(slug, arr) {
      photosMap[slug] = arr;
    }

    function renderGallery(gallery) {
      if (!gallery) return;
      const slug = gallery.dataset.slug;
      const photos = getStoredPhotos(slug);
      gallery.innerHTML = '';
      if (photos.length === 0) return;
      photos.forEach((ph, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'photo-item';
        const img = document.createElement('img');
        img.src = ph.url;
        img.dataset.index = idx;
        img.className = 'popup-photo';
        const del = document.createElement('span');
        del.className = 'photo-delete';
        del.dataset.index = idx;
        del.textContent = 'üóëÔ∏è';
        wrapper.appendChild(img);
        wrapper.appendChild(del);
        gallery.appendChild(wrapper);
      });
      adjustGalleryLayout(gallery);
    }

    function adjustGalleryLayout(gallery) {
      const items = gallery.querySelectorAll('.photo-item');
      const count = items.length;
      items.forEach(item => {
        if (count === 1) {
          item.style.width = '100%';
        } else if (count === 2) {
          item.style.width = 'calc((100% - 2px) / 2)';
        } else {
          item.style.width = 'calc((100% - 4px) / 3)';
        }
      });
    }

    function setupGallery(gallery) {
      if (!gallery) return;
      renderGallery(gallery);
      gallery.addEventListener('click', e => {
        if (e.target.classList.contains('photo-delete')) {
          e.stopPropagation();
          const slug = gallery.dataset.slug;
          const idx = parseInt(e.target.dataset.index);
          const photos = getStoredPhotos(slug);
          photos.splice(idx, 1);
          storePhotos(slug, photos);
          renderGallery(gallery);
          markPinUnsaved(slug);
          updateSaveButton();
        } else if (e.target.tagName === 'IMG') {
          openPhotoModal(gallery.dataset.slug, parseInt(e.target.dataset.index));
        }
      });
    }

    function addPhotosToSlug(slug, files, gallery) {
      if (!files || files.length === 0) return;
      const existing = getStoredPhotos(slug);
      let idx = 0;
      function next() {
        if (idx >= files.length) {
          storePhotos(slug, existing);
          if (gallery) {
            renderGallery(gallery);
          }
          markPinUnsaved(slug);
          updateSaveButton();
          return;
        }
        const file = files[idx]; // [CODEx CHANGED] usuniƒôty limit rozmiaru 1 MB
        const reader = new FileReader();
        reader.onload = e => {
          existing.push({url: e.target.result});
          idx++;
          next();
        };
        reader.readAsDataURL(file);
      }
      next();
    }

    function setupAddPhotoButton(btn, slug, gallery) {
      if (!btn) return;
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true;
        input.addEventListener('change', () => {
          addPhotosToSlug(slug, Array.from(input.files || []), gallery);
        });
        input.click();
      });
    }

    function createPopupHtml(p) {
      const slug = p.slug || slugify(p.nazwa || '');
      const trudHtml = p.trudnosc !== undefined ?
        `<div class="trudnosc-wrapper">
          <div class="trudnosc-text" id="trudnoscLabel-${p.id}" style="color:${trudnoscColor(p.trudnosc)}">Poziom trudno≈õci: ${trudnoscText(p.trudnosc)}</div>
        </div>` : '';
      return `
        <div class="photo-gallery" data-slug="${slug}"></div>
        <b>${p.emoji ? emojiHtml(p.emoji) + ' ' : ''}${p.nazwa}</b>
        ${trudHtml}
        <div style="border-top:1px solid #444;"></div>
        <div style="height:4px;"></div>
        <div class="popup-description${p.opis && p.opis.length > 100 ? ' scrollable' : ''}">${linkify(p.opis)}</div>
        <div style="height:4px;"></div>
        <div style="border-top:1px solid #444;"></div>
        <div>Warstwa: ${p.warstwa || 'Inne'}</div>
        ${p.kategoria ? `<div>Kategoria: ${p.kategoria}</div>` : ''}
        ${p.nieaktywne ? `<div style="opacity:0.8;">Nieaktywne</div>` : ''}
        <div>Data dodania: ${formatDate(p.dataDodania)}</div>
        <div>${formatCoords(p.lat, p.lng)}</div>
        <div><a href="https://maps.google.com/?q=${p.lat},${p.lng}" target="_blank">üìç Google Maps</a></div>
        <button class="popup-edit-btn" id="editBtn-${p.id}">‚úèÔ∏è</button>
        <button class="popup-route-btn" id="routeBtn-${p.id}">‚úèÔ∏è Dodaj trasƒô</button>
      `;
    }

    function attachPopupHandlers(marker, p) {
    /*  console.log('Wywo≈Çano attachPopupHandlers dla pinezki:', p); // <-- dodane */
      const handler = e => {
        const container = e.popup.getElement();
        if (!container) return;
        setupGallery(container.querySelector('.photo-gallery'));
        const btn = container.querySelector(`#editBtn-${p.id}`);
        if (btn) {
          btn.addEventListener('click', ev => {
            ev.stopPropagation();
            edytuj(p.id, p.lat, p.lng);
          });
        }
        const rbtn = container.querySelector(`#routeBtn-${p.id}`);
        if (rbtn) {
          rbtn.addEventListener('click', ev => {
            ev.stopPropagation();
            map.closePopup();
            startRouteDrawing(p);
          });
        }
        const range = container.querySelector(`#trudnoscRange-${p.id}`);
        const label = container.querySelector(`#trudnoscLabel-${p.id}`);
        if (range && label) {
          label.textContent = trudnoscText(range.value);
          range.addEventListener('input', () => {
            const val = parseInt(range.value);
            label.textContent = trudnoscText(val);
            const cur = zmianyDoZapisania[p.id] || {};
            cur.trudnosc = val;
            zmianyDoZapisania[p.id] = cur;
            p.trudnosc = val;
            p.unsaved = true;
            updateSaveButton();
          });
        }
      };
      if (marker._editHandler) {
        marker.off('popupopen', marker._editHandler);
      }
      marker._editHandler = handler;
      marker.on('popupopen', handler);
    }

  

    function setupEmojiInput(input) {
      if (!input) return;
      const list = document.createElement('div');
      list.className = 'emoji-dropdown';
      const preview = document.createElement('img');
      preview.className = 'emoji-input-preview';
      preview.width = 28;
      preview.height = 28;
      input.parentNode.insertBefore(preview, input.nextSibling);

      function updatePreview() {
        const val = input.value.trim();
        const url = resolveEmoji(val);
        if (url && url.startsWith('http')) {
          preview.src = url;
          preview.style.display = 'inline-block';
        } else {
          preview.style.display = 'none';
        }
      }

      emojiList.forEach(({id, url}) => {
        const img = document.createElement('img');
        img.src = url;
        img.width = 24;
        img.height = 24;
        img.style.cursor = 'pointer';
        img.style.margin = '2px';
        img.addEventListener('mousedown', e => {
          e.preventDefault();
          input.value = id;
          updatePreview();
          list.style.display = 'none';
        });
        list.appendChild(img);
      });
      document.body.appendChild(list);

      function show() {
        const r = input.getBoundingClientRect();
        list.style.left = r.left + window.scrollX + 'px';
        list.style.top = r.bottom + window.scrollY + 'px';
        list.style.display = 'flex';
      }

      input.addEventListener('focus', show);
      input.addEventListener('click', show);
      input.addEventListener('blur', () => {
        setTimeout(() => { list.style.display = 'none'; }, 100);
      });
      input.addEventListener('input', updatePreview);
      updatePreview();
    }

    function setupEmojiPicker(container, pin) {
      if (!container || !pin) return;
      const preview = document.createElement('img');
      preview.className = 'emoji-picker-preview';
      preview.width = 28;
      preview.height = 28;
      function getCurrent() {
        const val = pin.noweEmoji !== undefined ? pin.noweEmoji : pin.emoji;
        if (!val || String(val).trim() === '' || val === 'undefined') {
          return 'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png';
        }
        return resolveEmoji(val);
      }
      preview.src = getCurrent();
      container.appendChild(preview);

      const grid = document.createElement('div');
      grid.className = 'emoji-picker-grid';
      emojiList.forEach(({id, url}) => {
        const img = document.createElement('img');
        img.src = url;
        img.addEventListener('click', e => {
          e.stopPropagation();
          preview.src = url;
          pin.noweEmoji = id;
          grid.style.display = 'none';
        });
        grid.appendChild(img);
      });
      container.appendChild(grid);

      preview.addEventListener('click', e => {
        e.stopPropagation();
        grid.style.display = grid.style.display === 'grid' ? 'none' : 'grid';
      });
      document.addEventListener('click', function hide(e) {
        if (!container.contains(e.target)) grid.style.display = 'none';
      });
    }

    function setupDropdownInput(input, itemsFn) {
      if (!input) return;
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      input.style.paddingRight = '20px';
      input.style.boxSizing = 'border-box';
      const arrow = document.createElement('span');
      arrow.textContent = '‚ñº';
      arrow.className = 'dropdown-arrow';
      wrapper.appendChild(arrow);
      const list = document.createElement('div');
      list.className = 'list-dropdown';
      wrapper.appendChild(list);

      function populate() {
        list.innerHTML = '';
        itemsFn().forEach(item => {
          const div = document.createElement('div');
          div.textContent = item;
          div.addEventListener('mousedown', e => {
            e.preventDefault();
            input.value = item;
            hide();
          });
          list.appendChild(div);
        });
      }
      function show() { populate(); list.style.display = 'block'; }
      function hide() { list.style.display = 'none'; }
      arrow.addEventListener('click', e => { e.stopPropagation(); list.style.display === 'block' ? hide() : show(); });
      document.addEventListener('click', e => { if (!wrapper.contains(e.target)) hide(); });
    }

    function setupTrudnoscInput(range, label) {
      if (!range || !label) return;
      function update() {
        label.textContent = trudnoscText(range.value);
        label.style.color = trudnoscColor(range.value);
      }
      update();
      range.addEventListener('input', update);
    }

    function initMap() {
      L.Popup.prototype.options.maxWidth = 800;
 map = L.map('map').setView([52.1, 20.9], 7);
      rysowaneTrasy.addTo(map);
      routingLayer = L.layerGroup().addTo(map);

      const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri'
      });
      const hill = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri',
        className: 'hillshade-dark'
      });
      const hist = L.tileLayer.wms('https://mapy.geoportal.gov.pl/wss/service/PZGIK/ORTO_ARCH/MapServer/WMSServer', {
        layers: 'Raster',
        format: 'image/png',
        transparent: false,
        version: '1.3.0',
        crs: L.CRS.EPSG3857,
        attribution: 'Geoportal.gov.pl \u2013 ortofotomapa historyczna'
      });
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });
      const labels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}');
      const roadsFull = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}');
      const roadsSimple = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', { maxNativeZoom: 12, maxZoom: 18 });

      baseLayer = sat;
      baseLayer.on('loading', showLoading);
      baseLayer.on('load', hideLoading);
      baseLayer.addTo(map);
      labels.addTo(map);
      roadsLayer = roadsFull;
      roadsLayer.addTo(map);

      document.querySelectorAll('input[name="basemap"]').forEach(radio => {
        radio.addEventListener('change', () => {
          map.removeLayer(baseLayer);
          baseLayer.off('loading', showLoading);
          baseLayer.off('load', hideLoading);
          baseLayer = (radio.value === 'sat') ? sat :
                      (radio.value === 'hill') ? hill :
                      (radio.value === 'hist') ? hist : osm;
          baseLayer.on('loading', showLoading);
          baseLayer.on('load', hideLoading);
          baseLayer.addTo(map);
          map.removeLayer(labels); map.removeLayer(roadsLayer);
          if (radio.value !== 'osm') { labels.addTo(map); roadsLayer.addTo(map); }
          currentBase = radio.value;
        });
      });

      document.querySelectorAll('input[name="streets"]').forEach(radio => {
        radio.addEventListener('change', () => {
          map.removeLayer(roadsLayer);
          roadsLayer = (radio.value === 'main') ? roadsSimple : roadsFull;
          if (currentBase !== 'osm') roadsLayer.addTo(map);
        });
      });
    map.on("click", e => { if (currentTool === "pin" && !drawingRoute && window.innerWidth > 800) onMapClick(e); });
    map.on(L.Draw.Event.CREATED, onRouteCreated);
    map.on('draw:drawstop', () => { drawingRoute = false; activeRoutePin = null; });

    if (window.innerWidth <= 700) {
      let startLatLng = null;
      let startPoint = null;
      let startTime = 0;
      let moved = false;
      map.on('touchstart', e => {
        startLatLng = e.latlng;
        startPoint = e.containerPoint;
        startTime = Date.now();
        moved = false;
      });
      map.on('touchmove', e => {
        if (!startPoint) return;
        if (e.containerPoint.distanceTo(startPoint) > 5) {
          moved = true;
        }
      });
      map.on('touchend', () => {
        if (!moved && startLatLng && Date.now() - startTime >= 2000) {
          openNewPinPopup(startLatLng);
        }
        startLatLng = null;
        startPoint = null;
      });
      map.on('dragstart', () => {
        if (followGps) {
          followGps = false;
          const btn = document.getElementById('gpsFollowBtn');
          if (btn) btn.style.display = 'block';
        }
      });
    }

    }

    async function loadLayersFromFirestore() {
      try {
        const snap = await db.collection('layers').orderBy('order').get();
        const order = [];
        snap.forEach(doc => {
          const data = doc.data();
          layerDocs[data.name] = doc.id;
          layerNamesById[doc.id] = data.name;
          if (data.name === 'Sztosy') sztosyId = doc.id;
          if (data.name && data.name.toLowerCase() === 'zwiedzone i niedostƒôpne') visitedId = doc.id;
          if (data.name === 'Tryb w ruchu') movingLayerId = doc.id;
          order.push(data.name);
          if (!warstwy[data.name]) {
            warstwy[data.name] = { lista: [], layer: L.layerGroup(), collapsed: true, emoji: data.emoji || '', loaded: false, loading: false };
          } else if (data.emoji) {
            warstwy[data.name].emoji = data.emoji;
          }
        });
        if (order.length > 0) {
          localStorage.setItem('warstwaOrder', JSON.stringify(order));
          initialLayerOrder = [...order];
          layerOrderChanged = false;
        }
      } catch (e) {
        console.error('B≈ÇƒÖd wczytywania warstw', e);
      }
    }

    
function zaladujPinezkiZFirestore() {
  showLoading();
  Promise.all([
    db.collection("pinezki2").get(),
    db.collection("Pinterest_Diane_G").get()
  ]).then(([snap1, snap2]) => {
    ;[snap1, snap2].forEach(snapshot => {
      snapshot.forEach(doc => {
      const p = doc.data();
      if (p.dataDodania && p.dataDodania.seconds !== undefined) {
        p.dataDodania = p.dataDodania.seconds * 1000;
      } else if (typeof p.dataDodania === 'string' || p.dataDodania instanceof Date) {
        p.dataDodania = new Date(p.dataDodania).getTime();
      }
      const firebaseId = doc.id;
      const id = p.IDpinezki;
      p.firebaseId = firebaseId;
      p.id = id;
      if (p.trudnosc !== undefined) {
        p.trudnosc = parseInt(p.trudnosc, 10);
      }
      p.nieaktywne = p.nieaktywne === true;
      p.slug = slugify(p.nazwa);
      if (!photosMap[p.slug]) {
        storePhotos(p.slug, (p.photos || []));
      }
      categories.add(p.kategoria || '');
      let warstwaNazwa = p.warstwa || "Inne";
      let warstwaId = layerDocs[warstwaNazwa];
      if (!warstwaId && layerNamesById[p.warstwa]) {
        warstwaId = p.warstwa;
        warstwaNazwa = layerNamesById[p.warstwa];
      }
      p.warstwaId = warstwaId || null;
      if (!warstwy[warstwaNazwa]) {
        warstwy[warstwaNazwa] = {
          lista: [],
          layer: L.layerGroup(),
          collapsed: true,
          emoji: ''
        };
      }

      const iconEmoji = warstwy[warstwaNazwa].emoji || p.emoji;
      const marker = L.marker([p.lat, p.lng], { icon: createEmojiIcon(iconEmoji, p.warstwaId) }).addTo(warstwy[warstwaNazwa].layer);
      if (p.trasy) {
        p.trasy.forEach(tr => {
          const color = tr.kolor || '#00ccff';
          const layer = L.polyline(tr.punkty.map(pt => [pt.lat, pt.lng]), {color, weight:4, className:'route-line'}).addTo(rysowaneTrasy);
          tr.layer = layer;
          layer.on('click', e => showRoutePopup(p.id, tr, e.latlng));
        });
      } else {
        p.trasy = [];
      }
      const popupDiv = document.createElement("div");
      popupDiv.className = "popup-container";
      popupDiv.innerHTML = createPopupHtml(p);
      marker.bindPopup(popupDiv);
      attachPopupHandlers(marker, p);

      p.marker = marker;
      applyInactiveStyle(p);
      warstwy[warstwaNazwa].lista.push(p);
      warstwy[warstwaNazwa].loaded = true;
      wszystkiePinezki.push(p);
    });
    });
    if (!localPinsLoaded) loadNewPinsFromLocal();
    updateCategoryFilter();
    generujListeWarstw();
  })
  .catch(err => {
    console.error("B≈ÇƒÖd pobierania pinezek:", err);
    if (!localPinsLoaded) loadNewPinsFromLocal();
    updateCategoryFilter();
    generujListeWarstw();
  }).finally(() => {
    hideLoading();
  });
}

    function edytuj(id, lat, lng) {
     /* console.log('Wywo≈Çano edytuj dla id:', id, 'lat:', lat, 'lng:', lng); // <-- dodane */
      const p = wszystkiePinezki.find(pp => pp.id === id);
      if (!p) return;
      delete p.noweEmoji;
      const container = document.createElement("div");
      container.className = "popup-container edit-popup";
      container.innerHTML = `
        <div class="photo-gallery" data-slug="${p.slug}"></div>
        <button class="popup-add-photo" data-slug="${p.slug}">üì∑</button>
        <input id="enazwa" value="${p.nazwa}" style="width: 100%"><br>
        <textarea id="eopis" style="width: 100%; height: 100px"></textarea><br>
        <input id="ewarstwa" value="${p.warstwa || ''}" placeholder="Warstwa" style="width: 100%"><br>
        <input id="ekategoria" value="${p.kategoria || ''}" placeholder="Kategoria" style="width: 100%"><br>
        <div class="trudnosc-wrapper">
          <div class="trudnosc-title">Poziom trudno≈õci</div>
          <input type="range" id="etrudnosc" class="trudnosc-range" min="1" max="5" step="1" value="${p.trudnosc ?? 3}">
          <div class="trudnosc-labels">
            <span>B.≈Çatwy</span><span>≈Åatwy</span><span>≈öredni</span><span>Trudny</span><span>B.trudny</span>
          </div>
          <div class="trudnosc-value" id="etrudnoscLabel" style="color:${trudnoscColor(p.trudnosc ?? 3)}">${trudnoscText(p.trudnosc ?? 3)}</div>
        </div>
        <label><input type="checkbox" id="enieaktywne" ${p.nieaktywne ? 'checked' : ''}> Nieaktywne</label><br>
        <button onclick="zapiszLokalnie('${id}')">üíæ Zapisz</button>
        <button id="deleteBtn-${id}">üóëÔ∏è</button>
        <div id="emojiPicker-${id}" class="emoji-picker"></div>
      `;
      const eOpisInput = container.querySelector('#eopis');
      if (eOpisInput) {
        eOpisInput.value = (p.opis || '').replace(/<br\s*\/?>/gi, '\n');
      }
      setupEmojiPicker(container.querySelector(`#emojiPicker-${id}`), p);
      setupGallery(container.querySelector('.photo-gallery'));
      setupDropdownInput(container.querySelector('#ewarstwa'), () => Object.keys(warstwy));
      setupDropdownInput(container.querySelector('#ekategoria'), () => Array.from(categories).filter(c => c));
      setupAddPhotoButton(container.querySelector('.popup-add-photo'), p.slug, container.querySelector('.photo-gallery'));
      setupTrudnoscInput(container.querySelector('#etrudnosc'), container.querySelector('#etrudnoscLabel'));
      const chkInactive = container.querySelector('#enieaktywne');
      if (chkInactive) {
        chkInactive.addEventListener('change', () => {
          p.nieaktywne = chkInactive.checked;
          markPinUnsaved(p.slug);
          applyInactiveStyle(p);
        });
      }
      const delBtn = container.querySelector('#deleteBtn-' + id);
      if (delBtn) {
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          openDeleteModal(id);
        });
      }
      const marker = p.marker || findMarkerByLatLng(lat, lng);
      if (marker) {
        p.marker = marker;
        marker.bindPopup(container, {maxWidth: 400, minWidth: 400}).openPopup();
        marker.once('popupclose', () => {
          const popupDiv = document.createElement('div');
          popupDiv.className = 'popup-container';
          popupDiv.innerHTML = createPopupHtml(p);
          marker.bindPopup(popupDiv);
          attachPopupHandlers(marker, p);
        });
      }
    }

    function zapiszLokalnie(id) {
      const layerVal = document.getElementById("ewarstwa").value.trim();
      if (layerVal && !warstwy[layerVal]) addLayer(layerVal);
      const catVal = document.getElementById("ekategoria").value.trim();
      if (catVal && !categories.has(catVal)) { categories.add(catVal); updateCategoryFilter(); }
      const p = wszystkiePinezki.find(pp => pp.id === id);
      const emojiVal = p && p.noweEmoji !== undefined ? p.noweEmoji : (p ? p.emoji : '');
      const nowa = {
        nazwa: document.getElementById("enazwa").value,
        opis: document.getElementById("eopis").value.replace(/\n/g, '<br>'),
        warstwa: layerVal,
        warstwaId: layerDocs[layerVal] || null,
        kategoria: catVal,
        emoji: emojiVal,
        trudnosc: parseInt(document.getElementById("etrudnosc").value, 10),
        nieaktywne: document.getElementById("enieaktywne").checked
      };
      zmianyDoZapisania[id] = nowa;
      if (p) {
        const staraWarstwa = p.warstwa || "Inne";
        const oldSlug = p.slug;
        Object.assign(p, nowa);
        delete p.noweEmoji;
        categories.add(p.kategoria || '');
        selectedCategories.add(p.kategoria || '');
        updateCategoryFilter();
        p.slug = slugify(p.nazwa);
        if (oldSlug !== p.slug) {
          const photos = getStoredPhotos(oldSlug);
          delete photosMap[oldSlug];
          storePhotos(p.slug, photos);
        }
        p.unsaved = true;
        if (staraWarstwa !== p.warstwa) {
          const idx = warstwy[staraWarstwa].lista.indexOf(p);
          if (idx > -1) warstwy[staraWarstwa].lista.splice(idx, 1);
          if (!warstwy[p.warstwa]) {
            warstwy[p.warstwa] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '' };
          }
          warstwy[p.warstwa].lista.push(p);
          if (p.marker) p.marker.remove();
          const iconEmoji = warstwy[p.warstwa].emoji || p.emoji;
          p.marker = L.marker([p.lat, p.lng], {icon: createEmojiIcon(iconEmoji, p.warstwaId)}).addTo(warstwy[p.warstwa].layer);
          attachHighlight(p.marker, p.el);
        } else {
          const iconEmoji = warstwy[p.warstwa].emoji || p.emoji;
          p.marker.setIcon(createEmojiIcon(iconEmoji, p.warstwaId));
        }
        applyInactiveStyle(p);
        
const popupDiv = document.createElement("div");
popupDiv.className = "popup-container";
popupDiv.innerHTML = createPopupHtml(p);
p.marker.bindPopup(popupDiv);
attachPopupHandlers(p.marker, p);

      }
      generujListeWarstw();
      updateSaveButton();
      map.closePopup();
    }


    function openNewPinPopup(latlng) {
      const saveBtnTmp = document.getElementById('saveChanges');
      if (saveBtnTmp) saveBtnTmp.style.display = 'block';
      const marker = L.marker(latlng, {icon: createEmojiIcon("üìç", null, 24)}).addTo(map);
      const container = document.createElement("div");
      // Zapobiega zamykaniu popupu przy dotyku na urzƒÖdzeniach mobilnych
      // i umo≈ºliwia poprawne dzia≈Çanie przycisk√≥w wewnƒÖtrz popupu.
      L.DomEvent.disableClickPropagation(container);
      const coordsDisplay = formatCoords(latlng.lat, latlng.lng);
      container.innerHTML = `
        <div>${coordsDisplay}<br>
        <a href="https://maps.google.com/?q=${latlng.lat},${latlng.lng}" target="_blank">üìç Google Maps</a></div><br>
        <input id="nazwaNew" placeholder="Nazwa" style="width: 100%"><br>
        <textarea id="opisNew" placeholder="Opis" style="width: 100%"></textarea><br>
        <input id="warstwaNew" placeholder="Warstwa" style="width: 100%"><br>
        <input id="kategoriaNew" placeholder="Kategoria" style="width: 100%"><br>
        <input id="emojiNew" placeholder="Emoji" style="width: 100%"><br>
        <label><input type="checkbox" id="nieaktywneNew"> Nieaktywne</label><br>
        <button id="saveNew">üíæ Zapisz</button>
        <button id="cancelNew">Anuluj</button>`;
      setupEmojiInput(container.querySelector('#emojiNew'));

      setupDropdownInput(container.querySelector('#warstwaNew'), () => Object.keys(warstwy));
      setupDropdownInput(container.querySelector('#kategoriaNew'), () => Array.from(categories).filter(c => c));

      const popup = marker.bindPopup(container).openPopup();

      const chkNewInactive = container.querySelector('#nieaktywneNew');
      if (chkNewInactive) {
        chkNewInactive.addEventListener('change', () => {
          const tmp = { marker, el: null, nieaktywne: chkNewInactive.checked };
          applyInactiveStyle(tmp);
        });
      }

      let saved = false;
      const removeOnClose = () => {
        if (!saved && map.hasLayer(marker)) {
          map.removeLayer(marker);
        }
        marker.off('popupclose', removeOnClose);
        if (!saved) updateSaveButton();
      };
      marker.on('popupclose', removeOnClose);

        container.querySelector("#saveNew").addEventListener("click", (e) => {
          e.stopPropagation();
          const layerVal = container.querySelector("#warstwaNew").value.trim();
          if (layerVal && !warstwy[layerVal]) addLayer(layerVal);
          const catVal = container.querySelector("#kategoriaNew").value.trim();
          if (catVal && !categories.has(catVal)) { categories.add(catVal); updateCategoryFilter(); }
          const newId = crypto.randomUUID();
          const data = {
            id: newId,
            IDpinezki: newId,
            nazwa: container.querySelector("#nazwaNew").value,
            opis: container.querySelector("#opisNew").value.replace(/\n/g, '<br>'),
            warstwa: layerVal,
            kategoria: catVal,
            emoji: container.querySelector("#emojiNew").value,
            nieaktywne: container.querySelector("#nieaktywneNew").checked,
            lat: latlng.lat,
            lng: latlng.lng,
            dataDodania: Date.now(),
            unsaved: true,
            firebaseId: null
          };
        saved = true;

        const warstwaN = data.warstwa || "Inne";
        data.warstwaId = layerDocs[warstwaN] || null;
        if (!warstwy[warstwaN]) {
          warstwy[warstwaN] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '', loaded: true, loading: false };
        }
        data.marker = marker;
        const iconEmoji = warstwy[warstwaN].emoji || data.emoji;
        marker.setIcon(createEmojiIcon(iconEmoji, data.warstwaId));
        applyInactiveStyle(data);
        data.slug = slugify(data.nazwa);
        if (!photosMap[data.slug]) {
          storePhotos(data.slug, []);
        }
        categories.add(data.kategoria || '');
        selectedCategories.add(data.kategoria || '');
        updateCategoryFilter();
        const popupDiv = document.createElement('div');
        popupDiv.className = 'popup-container';
        popupDiv.innerHTML = createPopupHtml(data);
        marker.bindPopup(popupDiv);
        attachPopupHandlers(marker, data);

        nowePinezki.push(data);
        localStorage.setItem('nowePinezki', JSON.stringify(nowePinezki.map(p => {
          const {marker, ...rest} = p;
          return rest;
        })));
        warstwy[warstwaN].lista.push(data);
        wszystkiePinezki.push(data);
        generujListeWarstw();
        updateSaveButton();
        map.closePopup();
      });

      container.querySelector("#cancelNew").addEventListener("click", (e) => {
        e.stopPropagation();
        map.closePopup();
      });
    }
    function onMapClick(e) {
      openNewPinPopup(e.latlng);
    }

    function findMarkerByLatLng(lat, lng) {
      for (const layer of Object.values(map._layers)) {
        if (
  layer.getLatLng &&
  Math.abs(layer.getLatLng().lat - lat) < 1e-6 &&
  Math.abs(layer.getLatLng().lng - lng) < 1e-6
) {
          return layer;
        }
      }
      return null;
    }

    function loadLayerOrder() {
      try {
        return JSON.parse(localStorage.getItem('warstwaOrder')) || [];
      } catch (e) {
        return [];
      }
    }

    function saveLayerOrder() {
      const order = Array.from(document.querySelectorAll('#lista-warstw .warstwa'))
        .map(el => el.dataset.nazwa)
        .filter(n => !warstwy[n] || !warstwy[n].temporary);
      const prev = loadLayerOrder();
      localStorage.setItem('warstwaOrder', JSON.stringify(order));
      if (JSON.stringify(prev) !== JSON.stringify(order)) {
        layerOrderChanged = JSON.stringify(order) !== JSON.stringify(initialLayerOrder);
        updateSaveButton();
      }
    }

    function updateLayerNumbers() {
      document.querySelectorAll('#lista-warstw .warstwa').forEach((div, idx) => {
        const num = div.querySelector('.layer-number');
        if (num) num.textContent = idx + 1;
      });
    }

    function loadNewPinsFromLocal() {
      try {
        nowePinezki = JSON.parse(localStorage.getItem('nowePinezki')) || [];
      } catch (e) {
        nowePinezki = [];
      }
      localPinsLoaded = true;
      let changed = false;
      nowePinezki.forEach(p => {
        if (!p.IDpinezki) { p.IDpinezki = crypto.randomUUID(); changed = true; }
        if (!p.id) { p.id = p.IDpinezki; changed = true; }
        if (p.firebaseId === undefined) p.firebaseId = null;
        p.unsaved = true;
        if (p.nieaktywne === undefined) p.nieaktywne = false;
        if (!p.slug) p.slug = slugify(p.nazwa);
        if (!p.dataDodania) p.dataDodania = Date.now();
        categories.add(p.kategoria || '');
        selectedCategories.add(p.kategoria || '');
        const warstwaN = p.warstwa || 'Inne';
        p.warstwaId = layerDocs[warstwaN] || null;
        if (!warstwy[warstwaN]) {
          warstwy[warstwaN] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '', loaded: true, loading: false };
        }
        const iconEmoji = warstwy[warstwaN].emoji || p.emoji;
        const marker = L.marker([p.lat, p.lng], {icon: createEmojiIcon(iconEmoji, p.warstwaId)}).addTo(warstwy[warstwaN].layer);
        if (p.trasy) {
          p.trasy.forEach(tr => {
            const color = tr.kolor || '#00ccff';
            const layer = L.polyline(tr.punkty.map(pt => [pt.lat, pt.lng]), {color, weight:4, className:'route-line'}).addTo(rysowaneTrasy);
            tr.layer = layer;
            layer.on('click', e => showRoutePopup(p.id, tr, e.latlng));
          });
        } else {
          p.trasy = [];
        }
        const popupDiv = document.createElement('div');
        popupDiv.className = 'popup-container';
        popupDiv.innerHTML = createPopupHtml(p);
        marker.bindPopup(popupDiv);
        attachPopupHandlers(marker, p);
        p.marker = marker;
        applyInactiveStyle(p);
        warstwy[warstwaN].lista.push(p);
        wszystkiePinezki.push(p);
      });
      if (changed) localStorage.setItem('nowePinezki', JSON.stringify(nowePinezki.map(p => {
        const {marker, ...rest} = p;
        return rest;
      })));
      updateSaveButton();
      updateCategoryFilter();
    }

    function setupDrag(div, handle) {
      handle.draggable = true;
      handle.addEventListener('dragstart', () => {
        draggedLayer = div;
        handle.classList.add('dragging');
      });
      handle.addEventListener('dragend', () => {
        handle.classList.remove('dragging');
        draggedLayer = null;
      });
      div.addEventListener('dragover', e => e.preventDefault());
      div.addEventListener('drop', e => {
        e.preventDefault();
        if (draggedLayer && draggedLayer !== div) {
          const lista = document.getElementById('lista-warstw');
          lista.insertBefore(draggedLayer, div);
          saveLayerOrder();
          updateLayerNumbers();
        }
      });
    }

    function highlightListItem(el) {
      if (highlightedItem) {
        highlightedItem.classList.remove('active');
      }
      highlightedItem = el;
      if (highlightedItem) {
        highlightedItem.classList.add('active');
        highlightedItem.scrollIntoView({behavior: 'smooth', block: 'nearest'});
      }
    }

    function attachHighlight(marker, el) {
      if (!marker) return;
      if (marker._highlightHandler) {
        marker.off('click', marker._highlightHandler);
      }
  marker._highlightHandler = () => {
    if (drawingRoute) return;
    highlightListItem(el);
    marker.openPopup();
  };
  marker.on('click', marker._highlightHandler);
}

    function applyInactiveStyle(p) {
      if (p.marker) {
        p.marker.setOpacity(p.nieaktywne ? 0.5 : 1);
        const el = p.marker.getElement();
        if (el) el.style.filter = p.nieaktywne ? 'saturate(50%)' : '';
      }
      if (p.el) {
        if (p.nieaktywne) {
          p.el.classList.add('inactive');
        } else {
          p.el.classList.remove('inactive');
        }
      }
    }

    function startRouteDrawing(pin) {
      drawingRoute = true;
      activeRoutePin = pin;
      const opts = {shapeOptions: {color: '#00ccff', weight: 4, className: 'route-line'}};
      const dh = new L.Draw.Polyline(map, opts);
      dh.enable();
    }

    function onRouteCreated(e) {
      if (!activeRoutePin) return;
      const layer = e.layer;
      rysowaneTrasy.addLayer(layer);
      const latlngs = layer.getLatLngs().map(pt => ({lat: pt.lat, lng: pt.lng}));
      if (!activeRoutePin.trasy) activeRoutePin.trasy = [];
      const name = 'trasa ' + (activeRoutePin.trasy.length + 1);
      const tr = {nazwa: name, opis: '', kolor: '#00ccff', punkty: latlngs, layer};
      activeRoutePin.trasy.push(tr);
      layer.on('click', ev => showRoutePopup(activeRoutePin.id, tr, ev.latlng));
      window.localTrasy.push({action: 'add', pinId: activeRoutePin.id});
      zmianyDoZapisania[activeRoutePin.id] = Object.assign(zmianyDoZapisania[activeRoutePin.id] || {}, {
        trasy: activeRoutePin.trasy.map(t => ({nazwa: t.nazwa, opis:t.opis||'', kolor:t.kolor||'#00ccff', punkty: t.punkty}))
      });
      updateSaveButton();
      generujListeWarstw();
    }

    function renameLayer(oldName, labelEl) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = oldName;
      labelEl.replaceWith(input);
      input.focus();
      input.select();

      function finish() {
        const newName = input.value.trim();
        applyRenameLayer(oldName, newName);
        generujListeWarstw();
        updateSaveButton();
        input.replaceWith(labelEl);
      }

      input.onblur = finish;
      input.onkeydown = e => {
        if (e.key === 'Enter') {
          input.blur();
        } else if (e.key === 'Escape') {
          input.value = oldName;
          input.blur();
        }
      };
    }

    function addLayer(name) {
      if (!name || warstwy[name]) return;
      warstwy[name] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '' };
      layersToAdd.push(name);
      const order = loadLayerOrder();
      order.unshift(name);
      localStorage.setItem('warstwaOrder', JSON.stringify(order));
      generujListeWarstw();
      updateSaveButton();
    }

    function deleteLayer(name) {
      if (!warstwy[name]) return;
      warstwy[name].lista.forEach(p => {
        if (p.firebaseId) pinsToDelete.push(p.id);
        const idxN = nowePinezki.indexOf(p);
        if (idxN > -1) nowePinezki.splice(idxN, 1);
        delete zmianyDoZapisania[p.id];
        if (p.marker) map.removeLayer(p.marker);
      });
      wszystkiePinezki = wszystkiePinezki.filter(pp => pp.warstwa !== name);
      map.removeLayer(warstwy[name].layer);
      delete warstwy[name];
      layersToDelete.push(name);
      const order = loadLayerOrder().filter(n => n !== name);
      localStorage.setItem('warstwaOrder', JSON.stringify(order));
      generujListeWarstw();
      updateSaveButton();
    }

    function confirmDeleteLayer(name) {
      openLayerDeleteModal(name);
    }
    let editedLayer = null;
    function showLayerEditor(name) {
      const panel = document.getElementById('layer-editor');
      if (!panel) return;
      editedLayer = name;
      document.getElementById('layerEditName').value = name;
      const order = loadLayerOrder();
      const idx = order.indexOf(name);
      document.getElementById('layerEditOrder').value = idx >= 0 ? idx + 1 : (order.length + 1);
      document.getElementById('layerEditEmoji').value = warstwy[name].emoji || '';
      panel.style.display = 'block';
    }

    function closeLayerEditor() {
      const panel = document.getElementById('layer-editor');
      if (panel) panel.style.display = 'none';
    }

    function applyLayerEdits() {
      const newName = document.getElementById('layerEditName').value.trim();
      const newOrder = parseInt(document.getElementById('layerEditOrder').value, 10);
      const newEmoji = document.getElementById('layerEditEmoji').value.trim();
      if (newName && newName !== editedLayer) {
        applyRenameLayer(editedLayer, newName);
        editedLayer = newName;
      }
      reorderLayer(editedLayer, newOrder);
      if (warstwy[editedLayer].emoji !== newEmoji) {
        warstwy[editedLayer].emoji = newEmoji;
        layerEmojiChanges[editedLayer] = newEmoji;
        updateMarkersForLayer(editedLayer);
      }
      generujListeWarstw();
      updateSaveButton();
      closeLayerEditor();
    }

    function applyRenameLayer(oldName, newName) {
      if (!newName || newName === oldName) return;
      if (warstwy[newName]) {
        alert('Warstwa o takiej nazwie ju≈º istnieje.');
        return;
      }
      const layer = warstwy[oldName];
      if (!layer) return;
      layer.lista.forEach(p => {
        const cur = zmianyDoZapisania[p.id] || {};
        cur.warstwa = newName;
        cur.warstwaId = layerDocs[newName] || p.warstwaId || null;
        zmianyDoZapisania[p.id] = cur;
        p.warstwa = newName;
        p.warstwaId = cur.warstwaId;
        p.unsaved = true;
      });
      warstwy[newName] = layer;
      delete warstwy[oldName];
      if (!layersToAdd.includes(newName) && !layerDocs[newName]) layersToAdd.push(newName);
      if (!layersToDelete.includes(oldName) && (layerDocs[oldName] || layersToAdd.includes(oldName))) layersToDelete.push(oldName);
      const order = loadLayerOrder().map(n => n === oldName ? newName : n);
      localStorage.setItem('warstwaOrder', JSON.stringify(order));
    }

    function reorderLayer(name, newPos) {
      let order = loadLayerOrder().filter(n => n !== name);
      newPos = Math.max(1, Math.min(newPos, order.length + 1));
      order.splice(newPos - 1, 0, name);
      localStorage.setItem('warstwaOrder', JSON.stringify(order));
      layerOrderChanged = JSON.stringify(order) !== JSON.stringify(initialLayerOrder);
      updateSaveButton();
    }

    function updateMarkersForLayer(name) {
      const layer = warstwy[name];
      if (!layer) return;
      layer.lista.forEach(p => {
        const emoji = layer.emoji || p.emoji;
        if (p.marker) p.marker.setIcon(createEmojiIcon(emoji, p.warstwaId));
        if (p.el) p.el.innerHTML = (emoji ? emojiHtml(emoji) + ' ' : '') + p.nazwa;
      });
    }

    function initLayerEditor() {
      const panel = document.getElementById('layer-editor');
      if (!panel) return;
      const closeBtn = document.getElementById('layerEditClose');
      const saveBtn = document.getElementById('layerEditSave');
      const delBtn = document.getElementById('layerEditDelete');
      const orderInput = document.getElementById('layerEditOrder');
      const emojiInput = document.getElementById('layerEditEmoji');
      setupEmojiInput(emojiInput);

      closeBtn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        closeLayerEditor();
      });
      saveBtn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        applyLayerEdits();
      });
      orderInput.addEventListener('change', e => {
        const val = parseInt(orderInput.value, 10);
        if (!isNaN(val) && editedLayer) {
          reorderLayer(editedLayer, val);
          generujListeWarstw();
          orderInput.value = val;
        }
      });
      delBtn.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        panel.style.display = 'none';
        confirmDeleteLayer(editedLayer);
      });
    }

    let editedRoute = null;
    function showRouteEditor(pinId, idx) {
      const panel = document.getElementById('route-editor');
      if (!panel) return;
      const pin = wszystkiePinezki.find(p => p.id === pinId);
      if (!pin || !pin.trasy || !pin.trasy[idx]) return;
      editedRoute = {pinId, idx};
      document.getElementById('routeEditName').value = pin.trasy[idx].nazwa;
      document.getElementById('routeEditDesc').value = pin.trasy[idx].opis || '';
      document.getElementById('routeEditColor').value = pin.trasy[idx].kolor || '#00ccff';
      panel.style.display = 'block';
    }

function closeRouteEditor() {
  const panel = document.getElementById('route-editor');
  if (panel) panel.style.display = 'none';
}

function showRoutePopup(pinId, tr, latlng) {
  if (!tr || !tr.layer) return;
  const content = `<b>${tr.nazwa}</b><br>${tr.opis || ''}<br><button id="delRouteBtn">Usu≈Ñ trasƒô</button>`;
  const popup = L.popup()
    .setLatLng(latlng || tr.layer.getBounds().getCenter())
    .setContent(content)
    .openOn(map);
  const btn = popup.getElement().querySelector('#delRouteBtn');
  if (btn) {
    btn.addEventListener('click', () => {
      const pin = wszystkiePinezki.find(p => p.id === pinId);
      if (!pin) return;
      const idx = pin.trasy.indexOf(tr);
      if (idx > -1) {
        pin.trasy.splice(idx,1);
        if (tr.layer) rysowaneTrasy.removeLayer(tr.layer);
        zmianyDoZapisania[pin.id] = Object.assign(zmianyDoZapisania[pin.id] || {}, {trasy: pin.trasy.map(t => ({nazwa:t.nazwa, opis:t.opis||'', kolor:t.kolor||'#00ccff', punkty:t.punkty}))});
        window.localTrasy.push({action:'delete', pinId: pin.id});
        generujListeWarstw();
        updateSaveButton();
        map.closePopup();
      }
    });
  }
}

    function applyRouteEdits() {
      if (!editedRoute) return;
      const pin = wszystkiePinezki.find(p => p.id === editedRoute.pinId);
      if (!pin || !pin.trasy || !pin.trasy[editedRoute.idx]) return;
      const name = document.getElementById('routeEditName').value.trim() || pin.trasy[editedRoute.idx].nazwa;
      const desc = document.getElementById('routeEditDesc').value.trim();
      const color = document.getElementById('routeEditColor').value || '#00ccff';
      pin.trasy[editedRoute.idx].nazwa = name;
      pin.trasy[editedRoute.idx].opis = desc;
      pin.trasy[editedRoute.idx].kolor = color;
      if (pin.trasy[editedRoute.idx].layer) {
        pin.trasy[editedRoute.idx].layer.setStyle({color});
      }
      pin.trasy[editedRoute.idx].unsaved = true;
      zmianyDoZapisania[pin.id] = Object.assign(zmianyDoZapisania[pin.id] || {}, {trasy: pin.trasy.map(t => ({nazwa:t.nazwa, opis:t.opis||'', kolor:t.kolor||'#00ccff', punkty:t.punkty}))});
      window.localTrasy.push({action:'update', pinId: pin.id});
      generujListeWarstw();
      updateSaveButton();
      closeRouteEditor();
    }

    document.getElementById('routeEditDelete').addEventListener('click', function(){
      if (!editedRoute) return;
      const pin = wszystkiePinezki.find(p => p.id === editedRoute.pinId);
      if (!pin || !pin.trasy || !pin.trasy[editedRoute.idx]) return;
      const tr = pin.trasy.splice(editedRoute.idx,1)[0];
      if (tr && tr.layer) rysowaneTrasy.removeLayer(tr.layer);
      zmianyDoZapisania[pin.id] = Object.assign(zmianyDoZapisania[pin.id] || {}, {trasy: pin.trasy.map(t => ({nazwa:t.nazwa, opis:t.opis||'', kolor:t.kolor||'#00ccff', punkty:t.punkty}))});
      window.localTrasy.push({action:'delete', pinId: pin.id});
      generujListeWarstw();
      updateSaveButton();
      closeRouteEditor();
    });

    function showSearchMarker(lat, lng, label) {
      if (searchLayer) {
        map.removeLayer(searchLayer.layer);
        delete warstwy['wyszukane'];
        searchLayer = null;
        searchMarker = null;
      }
      searchLayer = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '', temporary: true };
      warstwy['wyszukane'] = searchLayer;
      const latlng = L.latLng(lat, lng);
      searchMarker = L.marker(latlng, {icon: greenIcon}).addTo(searchLayer.layer);
      const coordsDisplay = formatCoords(lat, lng);
      const container = document.createElement('div');
      container.innerHTML = `${label}<br>${coordsDisplay}<br><button id="addSearchPin">dodaj pinezkƒô</button>`;
      searchMarker.bindPopup(container).openPopup();
      container.querySelector('#addSearchPin').addEventListener('click', () => {
        if (searchLayer) {
          map.removeLayer(searchLayer.layer);
          delete warstwy['wyszukane'];
          searchLayer = null;
          searchMarker = null;
          generujListeWarstw();
        }
        openNewPinPopup(latlng);
      });
      searchLayer.lista.push({ id: 'search', nazwa: label, marker: searchMarker, lat, lng });
      generujListeWarstw();
    }

    function initGeoSearch() {
      const input = document.getElementById('geosearch');
      if (!input) return;
      input.addEventListener('keydown', e => {
        if (e.key !== 'Enter') return;
        const q = input.value.trim();
        if (!q) return;
        const m = q.match(/^(-?\d+(?:\.\d+)?)[ ,]+(-?\d+(?:\.\d+)?)/);
        if (m) {
          const lat = parseFloat(m[1]);
          const lng = parseFloat(m[2]);
          map.setView([lat, lng], 16);
          showSearchMarker(lat, lng, q);
          return;
        }
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            if (data && data[0]) {
              const lat = parseFloat(data[0].lat);
              const lng = parseFloat(data[0].lon);
              map.setView([lat, lng], 16);
              showSearchMarker(lat, lng, data[0].display_name);
            } else {
              alert('Nie znaleziono adresu');
            }
          })
          .catch(err => {
            console.error('Geocoding error', err);
            alert('B≈ÇƒÖd geokodowania');
          });
      });
    }

    function initRouteSearch() {
      const btn = document.getElementById('routeCalculate');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const start = document.getElementById('routeStart').value.trim();
        const end = document.getElementById('routeEnd').value.trim();
        if (!start || !end) {
          alert('Podaj adresy obu punkt√≥w');
          return;
        }
        await showRoute(start, end);
      });
    }

    async function geocodeAddress(addr) {
      const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
      const data = await resp.json();
      if (!data || !data[0]) throw new Error('Nie znaleziono adresu');
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    async function showRoute(startAddr, endAddr) {
      try {
        if (window.google && google.maps && google.maps.DirectionsService) {
          const directionsService = new google.maps.DirectionsService();
          const res = await directionsService.route({
            origin: startAddr,
            destination: endAddr,
            travelMode: google.maps.TravelMode.DRIVING
          });
          const pts = res.routes[0].overview_path.map(p => [p.lat(), p.lng()]);
          routingLayer.clearLayers();
          const line = L.polyline(pts, {color: '#ff0000', weight: 4, className: 'route-line'}).addTo(routingLayer);
          map.fitBounds(line.getBounds());
        } else {
          const [sLat, sLon] = await geocodeAddress(startAddr);
          const [eLat, eLon] = await geocodeAddress(endAddr);
          const url = `https://router.project-osrm.org/route/v1/driving/${sLon},${sLat};${eLon},${eLat}?overview=full&geometries=geojson`;
          const r = await fetch(url);
          const json = await r.json();
          if (!json.routes || !json.routes[0]) throw new Error('Brak trasy');
          const coords = json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
          routingLayer.clearLayers();
          const line = L.polyline(coords, {color: '#ff0000', weight: 4, className: 'route-line'}).addTo(routingLayer);
          map.fitBounds(line.getBounds());
        }
      } catch (err) {
        console.error('Route error', err);
        alert('Nie uda≈Ço siƒô wyznaczyƒá trasy');
      }
    }

    function updateCategoryFilter() {
      const container = document.getElementById('kategorie-lista');
      if (!container) return;
      container.innerHTML = '';
      const cats = Array.from(categories).sort();
      if (selectedCategories.size === 0) {
        selectedCategories = new Set(cats);
      }
      const allDiv = document.createElement('div');
      const allChk = document.createElement('input');
      allChk.type = 'checkbox';
      allChk.id = 'kategorie-all';
      allChk.checked = selectedCategories.size === 0 || selectedCategories.size === categories.size;
      const allLbl = document.createElement('label');
      allLbl.textContent = 'Zaznacz wszystkie';
      allDiv.appendChild(allChk);
      allDiv.appendChild(allLbl);
      container.appendChild(allDiv);
      allChk.addEventListener('change', () => {
        if (allChk.checked) {
          selectedCategories = new Set(categories);
          container.querySelectorAll('.kat-item input').forEach(ch => ch.checked = true);
        } else {
          selectedCategories.clear();
          container.querySelectorAll('.kat-item input').forEach(ch => ch.checked = false);
        }
        generujListeWarstw();
      });
      cats.forEach(cat => {
        const div = document.createElement('div');
        div.className = 'kat-item';
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = cat;
        chk.checked = selectedCategories.size === 0 || selectedCategories.has(cat);
        const lbl = document.createElement('label');
        lbl.textContent = cat || 'Bez kategorii';
        div.appendChild(chk);
        div.appendChild(lbl);
        container.appendChild(div);
        chk.addEventListener('change', () => {
          selectedCategories = new Set(
            Array.from(container.querySelectorAll('.kat-item input')).filter(c => c.checked).map(c => c.value)
          );
          const all = document.getElementById('kategorie-all');
          if (all) all.checked = selectedCategories.size === categories.size;
          generujListeWarstw();
        });
      });
    }

    function updateMarkerVisibility() {
      Object.values(warstwy).forEach(w => {
        w.lista.forEach(p => {
          if (!p.marker) return;
          const visible = selectedCategories.size === 0 || selectedCategories.has(p.kategoria || '');
          if (visible) {
            if (!w.layer.hasLayer(p.marker)) {
              w.layer.addLayer(p.marker);
            }
          } else {
            if (w.layer.hasLayer(p.marker)) {
              w.layer.removeLayer(p.marker);
            }
          }
        });
      });
    }

    function generujListeWarstw() {
      updateMarkerVisibility();
      const lista = document.getElementById("lista-warstw");
      lista.innerHTML = "";
      const saved = loadLayerOrder();
      const nazwy = [...saved.filter(n => warstwy[n]), ...Object.keys(warstwy).filter(n => !saved.includes(n))];
      const tempLayers = nazwy.filter(n => warstwy[n].temporary);
      const regularLayers = nazwy.filter(n => !warstwy[n].temporary);
      const finalNazwy = [...tempLayers, ...regularLayers];
      finalNazwy.forEach((nazwa, idx) => {
        const div = document.createElement("div");
        div.className = "warstwa";
        div.dataset.nazwa = nazwa;
        const numberSpan = document.createElement("span");
        numberSpan.className = "layer-number";
        numberSpan.textContent = idx + 1;
        if (!warstwy[nazwa].temporary) {
          setupDrag(div, numberSpan);
        }
        const h3 = document.createElement("h3");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        if (warstwy[nazwa].visible === undefined) {
          warstwy[nazwa].visible = map.hasLayer(warstwy[nazwa].layer);
        }
        if (window.innerWidth <= 700 && !initialLayerVisibilitySet) {
          warstwy[nazwa].visible = false;
          map.removeLayer(warstwy[nazwa].layer);
        }
        checkbox.checked = warstwy[nazwa].visible;
        checkbox.onchange = () => {
          warstwy[nazwa].visible = checkbox.checked;
          if (checkbox.checked) {
            warstwy[nazwa].layer.addTo(map);
          } else {
            map.removeLayer(warstwy[nazwa].layer);
          }
        };
        const label = document.createElement("span");
        label.textContent = `${nazwa} (${warstwy[nazwa].lista.length})`;
        const left = document.createElement("span");
        left.appendChild(checkbox);
        left.appendChild(numberSpan);
        left.appendChild(label);
        const toggleBtn = document.createElement("span");
        toggleBtn.textContent = warstwy[nazwa].collapsed ? "‚ñ∂Ô∏è" : "üîΩ";
       toggleBtn.style.cursor = "pointer";
toggleBtn.style.display = "inline-block";
toggleBtn.style.verticalAlign = "top";
        const controls = document.createElement("span");
        if (!warstwy[nazwa].temporary) {
          const editBtn = document.createElement("span");
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.style.cursor = "pointer";
          editBtn.style.marginRight = "5px";
          editBtn.style.display = "inline-block";
          editBtn.style.verticalAlign = "top";
          editBtn.onclick = () => showLayerEditor(nazwa);
          controls.appendChild(editBtn);
        }
        controls.appendChild(toggleBtn);
        controls.style.display = "flex";
        controls.style.alignItems = "center";
        h3.appendChild(left);
        h3.appendChild(controls);
        div.appendChild(h3);

        const listaP = document.createElement("div");
        listaP.className = "pinezki-lista";

        const sorted = warstwy[nazwa].lista.slice().filter(p => {
          return selectedCategories.size === 0 || selectedCategories.has(p.kategoria || '');
        }).sort((a, b) => {
          const ad = a.dataDodania ? new Date(a.dataDodania).getTime() : 0;
          const bd = b.dataDodania ? new Date(b.dataDodania).getTime() : 0;
          const an = a.nazwa || '';
          const bn = b.nazwa || '';
          switch (sortMode) {
            case 'dateAsc':
              return ad - bd;
            case 'dateDesc':
              return bd - ad;
            case 'nameDesc':
              return bn.localeCompare(an);
            case 'nameAsc':
            default:
              return an.localeCompare(bn);
          }
        });
        sorted.forEach(p => {
          const el = document.createElement("div");
          el.className = "pinezka";
          const dispEmoji = warstwy[nazwa].emoji || p.emoji;
          el.innerHTML = (dispEmoji ? emojiHtml(dispEmoji) + ' ' : '') + p.nazwa;
          if (p.unsaved) el.classList.add('unsaved');
          el.onclick = () => {
            map.setView([p.lat, p.lng], 16);
            p.marker.openPopup();
            highlightListItem(el);
          };
          if (p.marker) {
            attachHighlight(p.marker, el);
          }
          p.el = el;
          applyInactiveStyle(p);
          listaP.appendChild(el);

          const trList = document.createElement('div');
          trList.className = 'trasy-lista';
          (p.trasy || []).forEach((tr, ti) => {
            const tEl = document.createElement('div');
            tEl.className = 'trasa-item';
            tEl.textContent = tr.nazwa;
            tEl.title = tr.opis || '';
            tEl.style.borderLeft = `4px solid ${tr.kolor || '#00ccff'}`;
            if (tr.unsaved) tEl.classList.add('unsaved');
            tEl.onclick = (e) => {
              e.stopPropagation();
              if (tr.layer) map.fitBounds(tr.layer.getBounds());
            };
            const editR = document.createElement('span');
            editR.textContent = '‚úèÔ∏è';
            editR.style.marginLeft = '5px';
            editR.onclick = (e) => { e.stopPropagation(); showRouteEditor(p.id, ti); };
            tEl.appendChild(editR);
            trList.appendChild(tEl);
          });
          el.appendChild(trList);
        });

        if (warstwy[nazwa].collapsed) listaP.classList.add("ukryta");
        toggleBtn.onclick = () => {
          warstwy[nazwa].collapsed = !warstwy[nazwa].collapsed;
          listaP.classList.toggle("ukryta");
          toggleBtn.textContent = listaP.classList.contains("ukryta") ? "‚ñ∂Ô∏è" : "üîΩ";
        };

        div.appendChild(listaP);
        lista.appendChild(div);
        const sep = document.createElement('hr');
        sep.className = 'layer-separator';
        lista.appendChild(sep);
      });
      saveLayerOrder();
      updateLayerNumbers();

      if (window.innerWidth <= 700) {
        initialLayerVisibilitySet = true;
      }

      document.getElementById("wyszukiwarka").addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        document.querySelectorAll(".pinezka").forEach(el => {
          el.style.display = el.textContent.toLowerCase().includes(q) ? "block" : "none";
        });
      });
      allLayersVisible = Object.values(warstwy).every(w => w.visible);
      if (toggleVisibilityBtn) {
        toggleVisibilityBtn.textContent = allLayersVisible ? 'Ukryj wszystkie warstwy' : 'Poka≈º wszystkie warstwy';
      }
    }

    async function zapiszZmiany() {
      const btn = document.getElementById('saveChanges'); // [CODEx CHANGED] fragment w zapiszZmiany()
      const origLabel = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Zapisywanie‚Ä¶';
      try {
        let totalAll = 0;
        Object.entries(zmianyDoZapisania).forEach(([id]) => {
          const p = wszystkiePinezki.find(pp => pp.id === id);
          if (!p || !p.firebaseId) return;
          const lp = getStoredPhotos(p.slug) || [];
          lp.forEach(ph => { if (!ph.path) totalAll++; });
        });
        nowePinezki.forEach(p => {
          const lp = getStoredPhotos(p.slug) || [];
          lp.forEach(ph => { if (!ph.path) totalAll++; });
        });
        let doneAll = 0;
        const onProgress = () => {
          doneAll++;
          btn.textContent = `Zapisywanie‚Ä¶ (${doneAll}/${totalAll})`;
        };

        const updatePromises = Object.entries(zmianyDoZapisania).map(async ([id, data]) => {
          const p = wszystkiePinezki.find(pp => pp.id === id);
          if (!p || !p.firebaseId) return;
          if (Object.keys(data).length > 0) {
            await db.collection('pinezki2').doc(p.firebaseId).update(data);
          }
          const localPhotos = getStoredPhotos(p.slug);
          p.photos = await savePhotosForPin(p.firebaseId, p.slug, localPhotos, p.photos || [], onProgress);
          delete p.unsaved;
        });

        const addPromises = nowePinezki.map(async p => {
          const suffix = generateSuffix();
          const firebaseId = `${sanitize(p.nazwa)}_${suffix}`;
          p.firebaseId = firebaseId;
          const payload = {
            nazwa: p.nazwa,
            opis: p.opis,
            warstwa: p.warstwa,
            warstwaId: p.warstwaId || null,
            kategoria: p.kategoria,
            emoji: p.emoji,
            nieaktywne: p.nieaktywne || false,
            lat: p.lat,
            lng: p.lng,
            dataDodania: firebase.firestore.FieldValue.serverTimestamp(),
            IDpinezki: p.id,
            trasy: (p.trasy || []).map(t => ({nazwa: t.nazwa, opis: t.opis || '', kolor: t.kolor || '#00ccff', punkty: t.punkty}))
          };
          if (p.trudnosc !== undefined) payload.trudnosc = p.trudnosc;
          await db.collection('pinezki2').doc(firebaseId).set(payload);
          const localPhotos = getStoredPhotos(p.slug);
          p.photos = await savePhotosForPin(firebaseId, p.slug, localPhotos, [], onProgress);
        });

        const deletePinPromises = pinsToDelete.map(id => {
          const p = wszystkiePinezki.find(pp => pp.id === id);
          if (p && p.firebaseId) return db.collection('pinezki2').doc(p.firebaseId).delete().catch(()=>{});
          return Promise.resolve();
        });

        const orderList = loadLayerOrder();
        const layerUpdates = Object.keys(warstwy).map(name => {
          const order = orderList.indexOf(name);
          const docId = layerDocs[name];
          const payload = {name, order, emoji: warstwy[name].emoji || ''};
          if (docId) {
            return db.collection('layers').doc(docId).set(payload);
          } else if (layersToAdd.includes(name)) {
            return db.collection('layers').add(payload);
          }
          return Promise.resolve();
        });

        const layerDeletes = layersToDelete.map(name => {
          const id = layerDocs[name];
          if (id) return db.collection('layers').doc(id).delete().catch(()=>{});
          return Promise.resolve();
        });

        await Promise.all([...updatePromises, ...addPromises, ...deletePinPromises, ...layerUpdates, ...layerDeletes]);
        zmianyDoZapisania = {};
        nowePinezki = [];
        layersToAdd = [];
        layersToDelete = [];
        layerEmojiChanges = {};
        pinsToDelete = [];
        window.localTrasy = [];
        localStorage.removeItem('nowePinezki');
        btn.textContent = 'Zapisano ‚úî';
        location.reload();
      } catch (err) {
        console.error(err);
        alert('Nie uda≈Ço siƒô zapisaƒá zmian. Spr√≥buj ponownie.');
        btn.textContent = origLabel;
      } finally {
        setTimeout(() => {
          btn.textContent = origLabel;
          btn.disabled = false;
        }, 600);
      }
    }

    document.getElementById('saveChanges').addEventListener('click', zapiszZmiany);

    function escapeXml(str) {
      return String(str || '').replace(/[<>&'"]/g, c => {
        switch (c) {
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '&': return '&amp;';
          case '"': return '&quot;';
          case "'": return '&apos;';
          default: return c;
        }
      });
    }

    function buildKml(pins) {
      const placemarks = pins.map(p => {
        const name = escapeXml(p.nazwa);
        const desc = escapeXml(p.opis);
        return `<Placemark><name>${name}</name><description>${desc}</description><Point><coordinates>${p.lng},${p.lat},0</coordinates></Point></Placemark>`;
      }).join('');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document>${placemarks}</Document></kml>`;
    }

    async function exportPinsToKML() {
      try {
        const snapshot = await db.collection('pinezki2').get();
        const pins = [];
        snapshot.forEach(doc => pins.push(doc.data()));
        const kml = buildKml(pins);
        const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pinezki.kml';
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 0);
      } catch (err) {
        alert('B≈ÇƒÖd eksportu: ' + err.message);
      }
    }

    document.getElementById('exportKML').addEventListener('click', exportPinsToKML);

  document.addEventListener("DOMContentLoaded", () => {
    twemoji.parse(document.body, {
      folder: "svg",
      ext: ".svg"
    });
    const modal = document.getElementById('photoModal');
    if (modal) {
      modal.addEventListener('click', e => {
        if (e.target === modal || e.target.id === 'photoModalClose') {
          modal.style.display = 'none';
        }
      });
    }

    const delModal = document.getElementById('deleteModal');
    if (delModal) {
      document.getElementById('deleteConfirmYes').addEventListener('click', deletePinFromFirestore);
      document.getElementById('deleteConfirmNo').addEventListener('click', closeDeleteModal);
      delModal.addEventListener('click', e => {
        if (e.target === delModal) closeDeleteModal();
      });
    }

    const layerDelModal = document.getElementById("layerDeleteModal");
    if (layerDelModal) {
      document.getElementById("layerDeleteConfirmYes").addEventListener("click", confirmLayerDelete);
      document.getElementById("layerDeleteConfirmNo").addEventListener("click", closeLayerDeleteModal);
      layerDelModal.addEventListener("click", e => {
        if (e.target === layerDelModal) closeLayerDeleteModal();
      });
    }
    initLayerEditor();

    setupMobile();

  });

  let modalSlug = null;
  let modalIndex = null;
  function openPhotoModal(slug, idx) {
    modalSlug = slug;
    modalIndex = idx;
    const photos = getStoredPhotos(slug);
    const ph = photos[idx];
    if (!ph) return;
    const img = document.getElementById('photoModalImg');
    if (img) img.src = ph.url;
    const delBtn = document.getElementById('photoModalDelete');
    if (delBtn) {
      const gallery = document.querySelector(`.photo-gallery[data-slug="${slug}"]`);
      delBtn.style.display = gallery && gallery.closest('.edit-popup') ? 'block' : 'none';
    }
    const modal = document.getElementById('photoModal');
    if (modal) modal.style.display = 'flex';
  }

  function deleteCurrentPhoto() {
    if (modalSlug === null) return;
    const photos = getStoredPhotos(modalSlug);
    const removed = photos.splice(modalIndex, 1)[0];
    storePhotos(modalSlug, photos);
    const gallery = document.querySelector(`.photo-gallery[data-slug="${modalSlug}"]`);
    if (gallery) renderGallery(gallery);
    markPinUnsaved(modalSlug);
    updateSaveButton();
    modalSlug = null; modalIndex = null;
    const modal = document.getElementById('photoModal');
    if (modal) modal.style.display = 'none';
  }

  // === [CODEx REPLACED] Upload i zapis listy zdjƒôƒá z kompresjƒÖ ===
  async function savePhotosForPin(id, slug, localPhotos, remotePhotos, onProgress) {
    // localPhotos: [{url, path?}]   (nowe zdjƒôcia majƒÖ tylko 'url' = dataURL)
    // remotePhotos: [{url, path}]   (to co ju≈º jest w Firestore/Storage)
    const finalPhotos = [];
    const remoteMap = {};
    (remotePhotos || []).forEach(ph => { if (ph.path) remoteMap[ph.path] = ph; });

    let totalNew = 0;
    for (const ph of (localPhotos || [])) if (!ph.path) totalNew++;

    let doneNew = 0;

    for (const ph of (localPhotos || [])) {
      if (ph.path) {
        // istniejƒÖce zdjƒôcie zostaje
        finalPhotos.push({ url: ph.url, path: ph.path });
        delete remoteMap[ph.path];
      } else {
        // NOWE zdjƒôcie ‚Äî kompresja + upload
        const compressedDataUrl = await compressDataUrl(ph.url);
        // (opcjonalny) pr√≥g po kompresji:
        // if (compressedDataUrl.length > 500 * 1024) console.warn('Du≈ºe foto po kompresji');

        const fileName = `${Date.now()}_${Math.random().toString(36).slice(2)}.jpg`;
        const path = `pins/${id}/${fileName}`;
        const ref = storage.ref().child(path);

        await ref.putString(compressedDataUrl, 'data_url');
        const url = await ref.getDownloadURL();

        finalPhotos.push({ url, path });

        doneNew++;
        if (typeof onProgress === 'function') onProgress(doneNew, totalNew);
      }
    }

    // Usu≈Ñ ze Storage zdjƒôcia skasowane w UI
    const toDelete = Object.keys(remoteMap);
    for (const path of toDelete) {
      try { await storage.ref().child(path).delete(); } catch (e) {}
    }

    // Zapis listy zdjƒôƒá w dokumencie pinezki
    await db.collection('pinezki2').doc(id).update({ photos: finalPhotos });

    // Synchronizacja lokalnego cache'a je≈õli istnieje
    if (typeof storePhotos === 'function') {
      storePhotos(slug, finalPhotos);
    }

    return finalPhotos;
  }

  let deletePinId = null;
  function openDeleteModal(id) {
    deletePinId = id;
    const modal = document.getElementById('deleteModal');
    if (modal) {
      const txt = modal.querySelector('#deleteModalContent div');
      const p = wszystkiePinezki.find(pp => pp.id === id);
      if (txt && p) txt.textContent = `Czy na pewno chcesz usunƒÖƒá pinezkƒô ${p.nazwa}?`;
      modal.style.display = 'flex';
    }
  }

  function closeDeleteModal() {
    deletePinId = null;
    const modal = document.getElementById('deleteModal');
    if (modal) modal.style.display = 'none';
  }

  function deletePinFromFirestore() {
    if (!deletePinId) return;
    const p = wszystkiePinezki.find(pp => pp.id === deletePinId);
    if (!p || !p.firebaseId) return;
    db.collection('pinezki2').doc(p.firebaseId).delete().then(() => {
      closeDeleteModal();
      location.reload();
    }).catch(err => {
      alert('B\u0142\u0105d usuwania: ' + err.message);
      closeDeleteModal();
    });
  }

let layerDeleteName = null;
function openLayerDeleteModal(name) {
  layerDeleteName = name;
  const modal = document.getElementById("layerDeleteModal");
  if (modal) {
    const txt = modal.querySelector('#layerDeleteModalContent div');
    if (txt) txt.textContent = `Czy na pewno chcesz usunƒÖƒá warstwƒô ${name} i wszystkie jej pinezki?`;
    modal.style.display = "flex";
  }
}
function closeLayerDeleteModal() {
  layerDeleteName = null;
  const modal = document.getElementById("layerDeleteModal");
  if (modal) modal.style.display = "none";
}
function confirmLayerDelete() {
  if (!layerDeleteName) return;
  deleteLayer(layerDeleteName);
  closeLayerDeleteModal();
}

  let currentLocation = null;
  let currentMarker = null;
  const gpsIcon = L.divIcon({className:'gps-marker'});
  let followGps = true;

  function initGeolocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition(pos => {
      currentLocation = [pos.coords.latitude, pos.coords.longitude];
      if (!currentMarker) {
        currentMarker = L.marker(currentLocation, {icon: gpsIcon}).addTo(map);
        map.setView(currentLocation, 16);
      } else {
        currentMarker.setLatLng(currentLocation);
      }
      if (followGps) {
        map.setView(currentLocation, map.getZoom());
      }
    }, err => console.error('geo error', err), { enableHighAccuracy: true });
  }

  async function ensureMovingLayer() {
    if (movingLayerId) return;
    const snap = await db.collection('layers').where('name','==','Tryb w ruchu').get();
    if (!snap.empty) {
      movingLayerId = snap.docs[0].id;
    } else {
      const doc = await db.collection('layers').add({name:'Tryb w ruchu', order:Object.keys(warstwy).length});
      movingLayerId = doc.id;
    }
    const name = 'Tryb w ruchu';
    layerDocs[name] = movingLayerId;
    layerNamesById[movingLayerId] = name;
    if (!warstwy[name]) {
      warstwy[name] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '' };
    }
    generujListeWarstw();
  }

  async function saveMovingPin(name) {
    if (!currentLocation) {
      alert('Brak aktualnej lokalizacji');
      return;
    }
    await ensureMovingLayer();
    const suffix = generateSuffix();
    const firebaseId = `${sanitize(name)}_${suffix}`;
    const IDpinezki = crypto.randomUUID();
    await db.collection('pinezki2').doc(firebaseId).set({
      nazwa: name,
      opis: '',
      warstwa: 'Tryb w ruchu',
      warstwaId: movingLayerId,
      kategoria: '',
      emoji: '',
      lat: currentLocation[0],
      lng: currentLocation[1],
      dataDodania: firebase.firestore.FieldValue.serverTimestamp(),
      IDpinezki
    });
    const data = {
      id: IDpinezki,
      IDpinezki,
      firebaseId,
      nazwa: name,
      opis: '',
      warstwa: 'Tryb w ruchu',
      warstwaId: movingLayerId,
      kategoria: '',
      emoji: '',
      lat: currentLocation[0],
      lng: currentLocation[1],
      dataDodania: Date.now(),
      slug: slugify(name)
    };
    const marker = L.marker(currentLocation, {icon: createEmojiIcon('', movingLayerId)}).addTo(warstwy['Tryb w ruchu'].layer);
    const popupDiv = document.createElement('div');
    popupDiv.className = 'popup-container';
    popupDiv.innerHTML = createPopupHtml(data);
    marker.bindPopup(popupDiv);
    attachPopupHandlers(marker, data);
    data.marker = marker;
    warstwy['Tryb w ruchu'].lista.push(data);
    wszystkiePinezki.push(data);
    generujListeWarstw();
  }

  function saveCenterPin(form) {
    const latlng = map.getCenter();
    const layerVal = form.warstwa.trim();
    if (layerVal && !warstwy[layerVal]) addLayer(layerVal);
    const catVal = form.kategoria.trim();
    if (catVal && !categories.has(catVal)) { categories.add(catVal); updateCategoryFilter(); }
    const newId = crypto.randomUUID();
    const data = {
      id: newId,
      IDpinezki: newId,
      nazwa: form.nazwa,
      opis: form.opis.replace(/\n/g, '<br>'),
      warstwa: layerVal,
      kategoria: catVal,
      emoji: form.emoji,
      nieaktywne: form.nieaktywne,
      lat: latlng.lat,
      lng: latlng.lng,
      dataDodania: Date.now(),
      unsaved: true,
      firebaseId: null
    };
    const warstwaN = data.warstwa || 'Inne';
    data.warstwaId = layerDocs[warstwaN] || null;
    if (!warstwy[warstwaN]) {
      warstwy[warstwaN] = { lista: [], layer: L.layerGroup().addTo(map), collapsed: true, emoji: '', loaded: true, loading: false };
    }
    const marker = L.marker(latlng, {icon: createEmojiIcon(warstwy[warstwaN].emoji || data.emoji, data.warstwaId)}).addTo(warstwy[warstwaN].layer);
    applyInactiveStyle(data);
    data.marker = marker;
    data.slug = slugify(data.nazwa);
    if (!photosMap[data.slug]) {
      storePhotos(data.slug, []);
    }
    categories.add(data.kategoria || '');
    selectedCategories.add(data.kategoria || '');
    updateCategoryFilter();
    const popupDiv = document.createElement('div');
    popupDiv.className = 'popup-container';
    popupDiv.innerHTML = createPopupHtml(data);
    marker.bindPopup(popupDiv);
    attachPopupHandlers(marker, data);
    nowePinezki.push(data);
    localStorage.setItem('nowePinezki', JSON.stringify(nowePinezki.map(p => {
      const {marker, ...rest} = p;
      return rest;
    })));
    warstwy[warstwaN].lista.push(data);
    wszystkiePinezki.push(data);
    generujListeWarstw();
    updateSaveButton();
  }

  function setupMobile() {
    const btn = document.getElementById('savePinBtn');
    const modal = document.getElementById('mobilePinModal');
    const ok = document.getElementById('mobilePinOk');
    const cancel = document.getElementById('mobilePinCancel');
    const gpsBtn = document.getElementById('gpsFollowBtn');
    const nameInput = document.getElementById('mobilePinName');
    const descInput = document.getElementById('mobilePinDesc');
    const layerInput = document.getElementById('mobilePinLayer');
    const catInput = document.getElementById('mobilePinCategory');
    const emojiInput = document.getElementById('mobilePinEmoji');
    const inactiveInput = document.getElementById('mobilePinInactive');
    if (!btn || !modal || !ok || !cancel || !nameInput) return;

    function openGpsModal() {
      nameInput.value = '';
      descInput.style.display = 'none';
      layerInput.style.display = 'none';
      catInput.style.display = 'none';
      emojiInput.style.display = 'none';
      inactiveInput.parentElement.style.display = 'none';
      modal.style.display = 'flex';
    }

    function openCenterModal() {
      nameInput.value = '';
      descInput.value = '';
      layerInput.value = '';
      catInput.value = '';
      emojiInput.value = '';
      inactiveInput.checked = false;
      descInput.style.display = '';
      layerInput.style.display = '';
      catInput.style.display = '';
      emojiInput.style.display = '';
      inactiveInput.parentElement.style.display = '';
      modal.style.display = 'flex';
      setupEmojiInput(emojiInput);
      setupDropdownInput(layerInput, () => Object.keys(warstwy));
      setupDropdownInput(catInput, () => Array.from(categories).filter(c => c));
    }

    if (window.innerWidth <= 800) {
      btn.style.display = 'block';
      if (typeof map !== 'undefined' && map) {
        initGeolocation();
      } else {
        const iv = setInterval(() => {
          if (typeof map !== 'undefined' && map) {
            initGeolocation();
            clearInterval(iv);
          }
        }, 500);
      }
    }

    btn.addEventListener('click', () => {
      if (currentTool === 'pin') {
        openCenterModal();
      } else {
        openGpsModal();
      }
    });

    cancel.addEventListener('click', () => { modal.style.display = 'none'; });
    ok.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (!name) { modal.style.display = 'none'; return; }
      if (currentTool === 'pin') {
        saveCenterPin({
          nazwa: name,
          opis: descInput.value,
          warstwa: layerInput.value,
          kategoria: catInput.value,
          emoji: emojiInput.value,
          nieaktywne: inactiveInput.checked
        });
      } else {
        saveMovingPin(name);
      }
      modal.style.display = 'none';
    });

    if (gpsBtn) {
      gpsBtn.addEventListener('click', () => {
        followGps = true;
        gpsBtn.style.display = 'none';
        if (currentLocation) {
          map.setView(currentLocation, map.getZoom());
        }
      });
    }
  }

  </script>
  <div id="deleteModal">
    <div id="deleteModalContent">
      <div>Czy na pewno chcesz usunƒÖƒá pinezkƒô?</div>
      <button id="deleteConfirmYes">TAK</button>
      <button id="deleteConfirmNo">NIE</button>
    </div>
  </div>
    <div id="layerDeleteModal">
      <div id="layerDeleteModalContent">
        <div>Czy na pewno chcesz usunƒÖƒá warstwƒô i wszystkie jej pinezki?</div>
        <button id="layerDeleteConfirmYes">TAK</button>
        <button id="layerDeleteConfirmNo">NIE</button>
      </div>
    </div>
  <div id="photoModal">
    <span id="photoModalClose">&#10005;</span>
    <span id="photoModalDelete" onclick="deleteCurrentPhoto()">üóëÔ∏è</span>
    <img id="photoModalImg" src="">
  </div>
  <img id="centerMarker" src="https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png" alt="center marker">
  <button id="savePinBtn">ZAPISZ PIN</button>
  <div id="mobilePinModal" class="mobile-modal">
    <div class="mobile-modal-content">
      <input type="text" id="mobilePinName" placeholder="Nazwa pinezki">
      <textarea id="mobilePinDesc" placeholder="Opis"></textarea>
      <input type="text" id="mobilePinLayer" placeholder="Warstwa">
      <input type="text" id="mobilePinCategory" placeholder="Kategoria">
      <input type="text" id="mobilePinEmoji" placeholder="Emoji">
      <label><input type="checkbox" id="mobilePinInactive"> Nieaktywne</label>
      <div style="display:flex;gap:10px;justify-content:center;">
        <button id="mobilePinOk">Zapisz</button>
        <button id="mobilePinCancel">Anuluj</button>
      </div>
    </div>
  </div>
</body>
</html>
